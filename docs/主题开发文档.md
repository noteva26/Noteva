# Noteva 主题开发文档

> 版本：v0.1.4-beta

## 快速开始

Noteva 支持任意前端框架开发主题（React、Vue、原生 JS 等），只需遵循简单约定。

### 主题目录结构

```
themes/
└── my-theme/
    ├── theme.json          # 主题配置（必需）
    ├── settings.json       # 主题设置定义（可选）
    ├── dist/               # 构建输出（必需）
    │   └── index.html      # 入口文件
    └── preview.png         # 预览图（推荐）
```

### theme.json 示例

```json
{
  "name": "我的主题",
  "short": "my-theme",
  "description": "一个简洁的博客主题",
  "version": "1.0.0",
  "author": "Your Name"
}
```

## Noteva SDK

Noteva 会自动在主题页面注入 SDK，提供 `window.Noteva` 全局对象。

**重要：不要手动引入 SDK，后端会自动注入！**

### 初始化

```javascript
// 等待 SDK 就绪
Noteva.ready(() => {
  // SDK 已加载完成，可以使用所有 API
  init();
});

// 或使用 Promise
await Noteva.ready();
```

## 站点 API

### 获取站点信息

```javascript
const site = await Noteva.site.getInfo();
// 返回:
// {
//   version: "0.1.4-beta",
//   name: "站点名称",
//   description: "站点描述",
//   subtitle: "副标题",
//   logo: "/uploads/logo.png",
//   footer: "页脚内容",
//   email_verification_enabled: "false",
//   permalink_structure: "/posts/{slug}",
//   demo_mode: false
// }
```

### 获取导航菜单

```javascript
const nav = await Noteva.site.getNav();
// 返回:
// [
//   { id: 1, name: "首页", url: "/", target: "_self", children: [] },
//   { id: 2, name: "关于", url: "/about", target: "_self", children: [
//     { id: 3, name: "子菜单", url: "/sub", target: "_self" }
//   ]}
// ]
```

### 获取主题设置

主题可以通过 `settings.json` 定义自定义设置项，管理员在后台配置，主题通过 SDK 读取。

```javascript
// 获取所有设置
const settings = await Noteva.site.getThemeSettings();
// 返回: { "primary_color": "#3b82f6", "show_sidebar": "true", ... }

// 获取单个设置
const color = await Noteva.site.getThemeSettings('primary_color');
```

#### settings.json 格式

在主题根目录创建 `settings.json`，定义可配置项。后台会自动按 `sections` 分组显示，每个分组可折叠。

```json
{
  "sections": [
    {
      "id": "appearance",
      "title": "外观设置",
      "fields": [
        {
          "id": "primary_color",
          "label": "主题色",
          "type": "text",
          "default": "#3b82f6",
          "description": "主题的主要颜色"
        },
        {
          "id": "show_sidebar",
          "label": "显示侧边栏",
          "type": "switch",
          "default": true
        }
      ]
    }
  ]
}
```

#### 支持的字段类型

##### text — 单行文本

```json
{
  "id": "site_title",
  "type": "text",
  "label": "站点标题",
  "default": "",
  "description": "显示在页面顶部的标题",
  "placeholder": "输入标题"
}
```

标记 `"secret": true` 的字段会以密码框显示，且不会通过公开 API 返回（仅管理后台可见），适合存储 API Key 等敏感信息。

##### textarea — 多行文本

```json
{
  "id": "custom_css",
  "type": "textarea",
  "label": "自定义 CSS",
  "default": "",
  "description": "注入自定义样式"
}
```

##### switch — 开关

值为布尔类型。注意：数据库存储为字符串 `"true"` / `"false"`，读取时需要解析。

```json
{
  "id": "show_toc",
  "type": "switch",
  "label": "显示目录",
  "default": true,
  "description": "文章页是否显示侧边目录"
}
```

读取示例：
```javascript
const settings = await Noteva.site.getThemeSettings();
// settings.show_toc 可能是 true / false / "true" / "false"
const showToc = settings.show_toc === true || settings.show_toc === "true";
```

##### select — 下拉选择

`options` 必须是 `{ value, label }` 对象数组，不能是纯字符串。

```json
{
  "id": "layout_mode",
  "type": "select",
  "label": "布局模式",
  "default": "grid",
  "options": [
    { "value": "grid", "label": "网格布局" },
    { "value": "list", "label": "列表布局" },
    { "value": "timeline", "label": "时间线" }
  ]
}
```

##### number — 数字

支持 `min` / `max` 限制范围。

```json
{
  "id": "page_size",
  "type": "number",
  "label": "每页文章数",
  "default": 10,
  "min": 1,
  "max": 50
}
```

##### array — 可视化数组编辑器

用于管理结构化列表数据（如歌单、友链等）。后台会渲染可视化编辑器，支持添加/删除/排序。

`itemFields` 定义每条数据的字段结构，支持 `text` 和 `number` 类型。

```json
{
  "id": "friends_list",
  "type": "array",
  "label": "友链列表",
  "default": [],
  "description": "添加友情链接",
  "itemFields": [
    { "id": "name", "type": "text", "label": "名称" },
    { "id": "url", "type": "text", "label": "链接" },
    { "id": "avatar", "type": "text", "label": "头像" },
    { "id": "desc", "type": "text", "label": "描述" }
  ]
}
```

数据库中存储为 JSON 字符串，读取时需要解析：

```javascript
const settings = await Noteva.site.getThemeSettings();
let list = settings.friends_list;
// 可能是数组（已解析）或 JSON 字符串
if (typeof list === "string") {
  try { list = JSON.parse(list); } catch { list = []; }
}
// list: [{ name: "...", url: "...", avatar: "...", desc: "..." }, ...]
```

#### 完整 settings.json 示例

```json
{
  "sections": [
    {
      "id": "general",
      "title": "基本设置",
      "fields": [
        { "id": "primary_color", "type": "text", "label": "主题色", "default": "#3b82f6" },
        { "id": "layout_mode", "type": "select", "label": "布局", "default": "grid",
          "options": [
            { "value": "grid", "label": "网格" },
            { "value": "list", "label": "列表" }
          ]
        },
        { "id": "show_sidebar", "type": "switch", "label": "显示侧边栏", "default": true },
        { "id": "page_size", "type": "number", "label": "每页文章数", "default": 10, "min": 1, "max": 50 }
      ]
    },
    {
      "id": "music",
      "title": "音乐播放器",
      "fields": [
        { "id": "music_enabled", "type": "switch", "label": "启用播放器", "default": false },
        {
          "id": "music_playlist", "type": "array", "label": "歌单", "default": [],
          "itemFields": [
            { "id": "name", "type": "text", "label": "歌名" },
            { "id": "artist", "type": "text", "label": "歌手" },
            { "id": "url", "type": "text", "label": "音频地址" },
            { "id": "cover", "type": "text", "label": "封面地址" }
          ]
        }
      ]
    }
  ]
}
```

#### 数据类型注意事项

所有设置值在数据库中均以字符串形式存储。读取时：
- `switch` 类型：值可能是 `true`（布尔）或 `"true"`（字符串），建议用 `val === true || val === "true"` 判断
- `array` 类型：值可能是数组（已解析）或 JSON 字符串，建议先检查 `Array.isArray()`，否则 `JSON.parse()`
- `number` 类型：值可能是数字或字符串，建议用 `Number()` 转换

## 文章 API

### 获取文章列表

```javascript
const { articles, total, page, pageSize, hasMore } = await Noteva.articles.list({
  page: 1,
  pageSize: 10,
  category: 'tech',     // 可选：按分类
  tag: 'javascript',    // 可选：按标签
  keyword: '搜索词',     // 可选：搜索
});
```

### 获取单篇文章

```javascript
const article = await Noteva.articles.get('hello-world');  // 通过 slug
// 返回:
// {
//   id: 1,
//   title: "文章标题",
//   slug: "hello-world",
//   content: "Markdown 原文",
//   html: "渲染后的 HTML",
//   excerpt: "摘要",
//   cover_image: "封面图",
//   author: { id, username, avatar },
//   category: { id, name, slug },
//   tags: [{ id, name }],
//   created_at: "2026-01-01T00:00:00Z",
//   view_count: 100,
//   like_count: 10,
//   comment_count: 5,
//   is_pinned: false
// }
```

## 页面 API

### 获取自定义页面

```javascript
const page = await Noteva.pages.get('about');  // 通过 slug
// 返回:
// {
//   id: 1,
//   title: "关于",
//   slug: "about",
//   content: "Markdown",
//   html: "HTML"
// }
```

## 分类和标签 API

```javascript
// 获取所有分类
const categories = await Noteva.categories.list();

// 获取所有标签
const tags = await Noteva.tags.list();
```

## 评论 API

### 获取文章评论

```javascript
const comments = await Noteva.comments.list(articleId);
// 返回评论数组，包含嵌套的 replies
// 每个评论包含 is_author 字段标识是否为作者/管理员评论
```

### 发表评论

```javascript
// 游客评论
const comment = await Noteva.comments.create({
  articleId: 1,
  content: '评论内容',
  nickname: '昵称',      // 游客必填
  email: 'email@example.com',  // 可选
  parentId: null,        // 回复时填父评论 ID
});

// 管理员评论（已登录状态下自动使用账户信息）
const comment = await Noteva.comments.create({
  articleId: 1,
  content: '评论内容',
  parentId: null,
});
```

## 用户 API

> 注意：v0.0.7 起移除了前台用户注册/登录系统，仅保留管理员登录功能。普通访客以游客身份评论。

```javascript
// 检查登录状态（异步，会请求后端）
const currentUser = await Noteva.user.check();

// 同步检查（需先调用 check）
const isLoggedIn = Noteva.user.isLoggedIn();
const user = Noteva.user.getCurrent();
// user: { id, username, email, avatar, role, display_name }

// 登出（仅管理员）
await Noteva.user.logout();
```

## 路由辅助

```javascript
// 获取当前路径
const path = Noteva.router.getPath();  // "/posts/hello"

// 获取查询参数
const page = Noteva.router.getQuery('page');  // "2"

// 路由匹配
const match = Noteva.router.match('/posts/:slug');
// { matched: true, params: { slug: "hello" } }

// 导航
Noteva.router.push('/posts/new');
```

## 工具函数

```javascript
// 日期格式化
Noteva.utils.formatDate(date, 'YYYY-MM-DD');
Noteva.utils.formatDate(date, 'YYYY年MM月DD日');

// 相对时间
Noteva.utils.timeAgo(date);  // "3 天前"

// HTML 转义
Noteva.utils.escapeHtml('<script>');

// 截断文本
Noteva.utils.truncate(text, 100);

// 防抖/节流
const debouncedFn = Noteva.utils.debounce(fn, 300);
const throttledFn = Noteva.utils.throttle(fn, 100);

// 复制到剪贴板
await Noteva.utils.copyToClipboard(text);
```

## UI 组件

```javascript
// Toast 提示
Noteva.ui.toast('保存成功');
Noteva.ui.toast('操作失败', 'error');

// 确认对话框
const confirmed = await Noteva.ui.confirm('确定删除？');

// 加载状态
Noteva.ui.showLoading();
Noteva.ui.hideLoading();
```

## 事件系统

```javascript
// 监听事件
Noteva.events.on('user:login', (user) => {
  console.log('管理员登录:', user);
});

// 内置事件
// - theme:ready     主题加载完成
// - user:login      管理员登录
// - user:logout     管理员登出
// - route:change    路由变化
// - comment:create  评论发表
```

## 钩子系统

```javascript
// 注册钩子
Noteva.hooks.on('content_render', (context) => {
  // 内容渲染时触发
});

// 触发钩子
Noteva.hooks.trigger('custom_hook', data);
```

## 本地存储

```javascript
// 自动 JSON 序列化
Noteva.storage.set('key', { foo: 'bar' });
const data = Noteva.storage.get('key');
Noteva.storage.remove('key');
```

## SEO

```javascript
Noteva.seo.setTitle('页面标题');
Noteva.seo.setMeta({ description: '描述', keywords: '关键词' });
Noteva.seo.setOpenGraph({ title: '标题', image: '图片' });
```

## 插件兼容

主题需要预留插件注入点：

```html
<div id="noteva-slot-body-start"></div>
<div id="noteva-slot-header-before"></div>
<!-- 内容 -->
<div id="noteva-slot-article-top"></div>
<div id="noteva-slot-article-bottom"></div>
<div id="noteva-slot-footer-after"></div>
<div id="noteva-slot-body-end"></div>
```

## 完整示例：原生 JS 主题

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Theme</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div id="app">Loading...</div>
  <script src="./app.js"></script>
</body>
</html>
```

```javascript
// app.js
Noteva.ready(async () => {
  const app = document.getElementById('app');
  const site = await Noteva.site.getInfo();
  const nav = await Noteva.site.getNav();
  const { articles } = await Noteva.articles.list();
  
  app.innerHTML = `
    <header>
      <h1>${site.name}</h1>
      <nav>
        ${nav.map(item => `<a href="${item.url}">${item.name}</a>`).join('')}
      </nav>
    </header>
    <main>
      ${articles.map(a => `
        <article>
          <h2><a href="/posts/${a.slug}">${a.title}</a></h2>
          <p>${a.excerpt || ''}</p>
        </article>
      `).join('')}
    </main>
    <footer>${site.footer || ''}</footer>
  `;
});
```

## 开发调试

1. 启动后端：`cargo run`（端口 8080）
2. 主题放在 `themes/` 目录
3. 后台切换主题测试
4. 使用 `Noteva.debug.enable()` 开启调试模式

## 注意事项

1. **不要手动引入 SDK** - 后端自动注入
2. **使用 `Noteva.ready()`** - 确保 SDK 加载完成
3. **API 路径已封装** - 直接使用 SDK 方法，不要手动拼接
4. **导航支持二级菜单** - 检查 `children` 字段
