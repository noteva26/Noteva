# Noteva 插件开发文档

> 版本：v0.0.1-beta

## 快速开始

Noteva 插件系统允许你扩展博客功能，无需修改核心代码。

### 插件目录结构

```
plugins/
└── my-plugin/
    ├── plugin.json        # 插件配置（必需）
    ├── frontend.js        # 前端脚本（可选）
    ├── frontend.css       # 前端样式（可选）
    └── settings.json      # 设置项定义（可选）
```

## plugin.json 配置

```json
{
  "id": "my-plugin",
  "name": "我的插件",
  "version": "1.0.0",
  "description": "插件描述",
  "author": "Your Name",
  "hooks": {
    "frontend": ["body_end", "content_render"]
  },
  "shortcodes": ["my-shortcode"],
  "settings": true
}
```

### 字段说明

| 字段 | 必需 | 说明 |
|-----|------|------|
| `id` | ✓ | 插件唯一标识，小写字母和连字符 |
| `name` | ✓ | 插件显示名称 |
| `version` | ✓ | 版本号 |
| `description` | | 插件描述 |
| `author` | | 作者 |
| `hooks` | | 使用的钩子列表 |
| `shortcodes` | | 注册的短代码 |
| `settings` | | 是否有设置项 |

## settings.json 配置

定义插件的可配置项，后台会自动生成设置界面。

```json
{
  "sections": [
    {
      "id": "general",
      "title": "基本设置",
      "fields": [
        {
          "id": "text_field",
          "type": "text",
          "label": "文本输入",
          "default": "默认值",
          "placeholder": "请输入...",
          "description": "字段说明"
        },
        {
          "id": "switch_field",
          "type": "switch",
          "label": "开关选项",
          "default": true
        },
        {
          "id": "select_field",
          "type": "select",
          "label": "下拉选择",
          "default": "option1",
          "options": [
            {"value": "option1", "label": "选项1"},
            {"value": "option2", "label": "选项2"}
          ]
        },
        {
          "id": "number_field",
          "type": "number",
          "label": "数字输入",
          "default": 50,
          "min": 0,
          "max": 100
        }
      ]
    }
  ]
}
```

### 支持的字段类型

| 类型 | 说明 | 额外属性 |
|-----|------|---------|
| `text` | 单行文本 | `placeholder`, `maxLength` |
| `textarea` | 多行文本 | `rows` |
| `number` | 数字 | `min`, `max`, `step` |
| `switch` | 开关 | - |
| `select` | 下拉选择 | `options` |
| `color` | 颜色选择器 | - |
| `image` | 图片上传 | - |

## frontend.js 开发

### 基本结构

```javascript
(function() {
  const PLUGIN_ID = 'my-plugin';
  
  // 等待 Noteva SDK 加载
  function waitForNoteva(callback) {
    if (typeof Noteva !== 'undefined') {
      callback();
    } else {
      setTimeout(() => waitForNoteva(callback), 100);
    }
  }
  
  waitForNoteva(function() {
    // 插件初始化代码
    init();
    
    console.log('[Plugin] my-plugin loaded');
  });
  
  function init() {
    // 获取插件设置
    const settings = Noteva.plugins.getSettings(PLUGIN_ID);
    
    // 你的逻辑...
  }
})();
```

### 获取插件设置

```javascript
const settings = Noteva.plugins.getSettings('my-plugin');
// 返回 settings.json 中定义的字段值
```

### 使用钩子

```javascript
// 内容渲染时触发
Noteva.hooks.on('content_render', (context) => {
  // context: { path, query }
  processContent();
});

// 评论创建后触发
Noteva.hooks.on('comment_after_create', (comment, context) => {
  // comment: 新创建的评论
  // context: { articleId }
  onCommentCreated(comment);
});

// 页面加载完成
Noteva.ready(() => {
  initPlugin();
});
```

### 常用钩子列表

| 钩子名 | 触发时机 | 参数 |
|-------|---------|------|
| `content_render` | 内容渲染时 | `{ path, query }` |
| `comment_before_create` | 评论提交前 | `data` |
| `comment_after_create` | 评论提交后 | `comment, { articleId }` |
| `user_login_after` | 用户登录后 | `user` |
| `user_logout` | 用户登出时 | `user` |
| `body_end` | 页面加载完成 | - |

### 使用事件

```javascript
// 监听主题就绪
Noteva.events.on('theme:ready', () => {
  createUI();
});

// 监听用户登录
Noteva.events.on('user:login', (user) => {
  updateUI(user);
});
```

### 调用 API

```javascript
// GET 请求
const data = await Noteva.api.get('/comments/1');

// POST 请求
const result = await Noteva.api.post('/comments', {
  article_id: 1,
  content: '评论内容'
});
```

### 用户相关

```javascript
// 检查登录状态
const user = await Noteva.user.check();

if (Noteva.user.isLoggedIn()) {
  const currentUser = Noteva.user.getCurrent();
  // { id, username, email, avatar, role }
}
```

### UI 工具

```javascript
// Toast 提示
Noteva.ui.toast('操作成功', 'success');
Noteva.ui.toast('操作失败', 'error');

// 确认对话框
const confirmed = await Noteva.ui.confirm('确定要执行吗？');

// 加载状态
Noteva.ui.showLoading();
Noteva.ui.hideLoading();
```

### 本地存储

```javascript
// 存储数据
Noteva.storage.set('my-plugin-data', { key: 'value' });

// 读取数据
const data = Noteva.storage.get('my-plugin-data');

// 删除数据
Noteva.storage.remove('my-plugin-data');
```

## Shortcode 开发

Shortcode 允许用户在文章中插入特殊内容。

### 后端处理

在 `plugin.json` 中声明 shortcode：

```json
{
  "shortcodes": ["hide-until-reply"]
}
```

后端会将 `[hide-until-reply]内容[/hide-until-reply]` 转换为 HTML。

### 前端处理

```javascript
// 处理渲染后的 shortcode 元素
Noteva.hooks.on('content_render', () => {
  const elements = document.querySelectorAll('.my-shortcode');
  elements.forEach(el => {
    // 处理元素
  });
});
```

## 完整示例：回复可见插件

### plugin.json

```json
{
  "id": "hide-until-reply",
  "name": "回复可见",
  "version": "1.0.0",
  "description": "部分内容需要回复后才能查看",
  "author": "Noteva",
  "hooks": {
    "frontend": ["content_render", "comment_after_create"]
  },
  "shortcodes": ["hide-until-reply"],
  "settings": true
}
```

### settings.json

```json
{
  "sections": [{
    "id": "general",
    "title": "基本设置",
    "fields": [
      {
        "id": "placeholder_text",
        "type": "text",
        "label": "占位文字",
        "default": "回复后可见"
      }
    ]
  }]
}
```

### frontend.js

```javascript
(function() {
  const PLUGIN_ID = 'hide-until-reply';
  
  function waitForNoteva(callback) {
    if (typeof Noteva !== 'undefined') callback();
    else setTimeout(() => waitForNoteva(callback), 100);
  }
  
  waitForNoteva(function() {
    // 检查用户是否已回复
    async function checkUnlocked(articleId) {
      const user = await Noteva.user.check();
      if (!user) return false;
      
      try {
        const result = await Noteva.api.get(`/comments/${articleId}`);
        const comments = result.comments || [];
        
        function hasUserComment(list) {
          for (const c of list) {
            if (c.user_id === user.id) return true;
            if (c.replies && hasUserComment(c.replies)) return true;
          }
          return false;
        }
        
        return hasUserComment(comments);
      } catch {
        return false;
      }
    }
    
    // 解锁内容
    function unlockContent(articleId) {
      const elements = document.querySelectorAll(
        `.noteva-hidden-content[data-article-id="${articleId}"]`
      );
      elements.forEach(el => {
        const template = el.querySelector('.noteva-hidden-template');
        if (template) {
          el.innerHTML = template.innerHTML;
          el.className = 'noteva-revealed-content';
        }
      });
    }
    
    // 初始化
    async function init() {
      const elements = document.querySelectorAll('.noteva-hidden-content');
      for (const el of elements) {
        const articleId = parseInt(el.dataset.articleId);
        if (articleId && await checkUnlocked(articleId)) {
          unlockContent(articleId);
        }
      }
    }
    
    // 监听内容渲染
    Noteva.hooks.on('content_render', () => {
      setTimeout(init, 100);
    });
    
    // 监听评论创建
    Noteva.hooks.on('comment_after_create', (comment, ctx) => {
      setTimeout(() => {
        unlockContent(ctx.articleId);
        Noteva.ui.toast('内容已解锁！', 'success');
      }, 500);
    });
    
    // 页面加载时初始化
    Noteva.ready(() => setTimeout(init, 500));
    
    console.log('[Plugin] hide-until-reply loaded');
  });
})();
```

### frontend.css

```css
.noteva-hidden-content {
  padding: 20px;
  background: #f5f5f5;
  border-radius: 8px;
  text-align: center;
  color: #666;
}

.noteva-revealed-content {
  padding: 16px;
  background: #f0fdf4;
  border-left: 4px solid #22c55e;
  border-radius: 4px;
}
```

## 完整示例：音乐播放器插件

### plugin.json

```json
{
  "id": "music-player",
  "name": "音乐播放器",
  "version": "1.0.0",
  "description": "背景音乐播放器",
  "hooks": {
    "frontend": ["body_end"]
  },
  "settings": true
}
```

### settings.json

```json
{
  "sections": [{
    "id": "general",
    "title": "播放器设置",
    "fields": [
      {
        "id": "source_type",
        "type": "select",
        "label": "音乐来源",
        "default": "url",
        "options": [
          {"value": "url", "label": "直接 URL"},
          {"value": "netease", "label": "网易云音乐 ID"}
        ]
      },
      {
        "id": "music_url",
        "type": "text",
        "label": "音乐地址",
        "placeholder": "https://example.com/music.mp3"
      },
      {
        "id": "netease_id",
        "type": "text",
        "label": "网易云歌曲 ID",
        "placeholder": "2083785152"
      },
      {
        "id": "autoplay",
        "type": "switch",
        "label": "自动播放",
        "default": false
      },
      {
        "id": "volume",
        "type": "number",
        "label": "默认音量",
        "default": 50,
        "min": 0,
        "max": 100
      }
    ]
  }]
}
```

### frontend.js

```javascript
(function() {
  const PLUGIN_ID = 'music-player';
  const NETEASE_API = 'http://music.alger.fun/api/song/url?id=';
  
  async function getMusicUrl(settings) {
    if (settings.source_type === 'netease' && settings.netease_id) {
      try {
        const res = await fetch(NETEASE_API + settings.netease_id);
        const data = await res.json();
        if (data.code === 200 && data.data?.[0]?.url) {
          return data.data[0].url;
        }
      } catch (e) {
        console.error('[Music Player] Failed:', e);
      }
      return null;
    }
    return settings.music_url || null;
  }
  
  async function createPlayer() {
    const settings = Noteva.plugins.getSettings(PLUGIN_ID);
    const url = await getMusicUrl(settings);
    if (!url) return;
    
    const player = document.createElement('div');
    player.id = 'music-player';
    player.innerHTML = `
      <audio id="bg-music" src="${url}" ${settings.loop !== false ? 'loop' : ''}></audio>
      <button class="toggle">▶</button>
    `;
    document.body.appendChild(player);
    
    const audio = document.getElementById('bg-music');
    audio.volume = (settings.volume || 50) / 100;
    
    player.querySelector('.toggle').onclick = () => {
      if (audio.paused) {
        audio.play();
        player.querySelector('.toggle').textContent = '⏸';
      } else {
        audio.pause();
        player.querySelector('.toggle').textContent = '▶';
      }
    };
    
    if (settings.autoplay) {
      audio.play().catch(() => {});
    }
  }
  
  Noteva.events.on('theme:ready', createPlayer);
})();
```

## 插件启用/禁用

插件状态保存在 `data/plugins.json`：

```json
{
  "hide-until-reply": true,
  "music-player": false
}
```

后台管理界面可以启用/禁用插件。

## 调试技巧

1. 使用 `console.log` 输出调试信息
2. 检查浏览器控制台错误
3. 使用 `Noteva.debug.enable()` 开启调试模式
4. 检查网络请求确认 API 调用正确

## 注意事项

1. **等待 SDK 加载** - 使用 `waitForNoteva` 或 `Noteva.ready()`
2. **异步操作** - `Noteva.user.check()` 是异步的，需要 await
3. **DOM 时机** - React 等框架渲染需要时间，适当延迟处理
4. **插件 ID** - 必须与目录名一致
5. **设置缓存** - 修改设置后可能需要刷新页面
