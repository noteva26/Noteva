# Noteva 插件开发文档

> 版本：v0.1.2-beta

## 快速开始

Noteva 插件系统允许你扩展博客功能，无需修改核心代码。

Noteva 支持两种插件类型：
- **前端插件**：通过 JavaScript/CSS 在浏览器端运行，使用 Noteva SDK
- **WASM 后端插件**：通过 WebAssembly 在服务端沙盒中运行，可参与后端钩子处理

### 插件目录结构

```
plugins/
└── my-plugin/
    ├── plugin.json        # 插件配置（必需）
    ├── frontend.js        # 前端脚本（可选）
    ├── frontend.css       # 前端样式（可选）
    ├── backend.wasm       # WASM 后端模块（可选）
    ├── settings.json      # 设置项定义（可选）
    ├── migrations/        # 数据库迁移（可选）
    └── locales/           # 国际化文件（可选）
```

## plugin.json 配置

```json
{
  "id": "my-plugin",
  "name": "我的插件",
  "version": "1.0.0",
  "description": "插件描述",
  "author": "Your Name",
  "requires": {
    "noteva": ">=0.1.1"
  },
  "hooks": {
    "frontend": ["body_end", "content_render"],
    "backend": ["article_before_create", "comment_content_filter"]
  },
  "permissions": ["read_articles", "read_config"],
  "shortcodes": ["my-shortcode"],
  "settings": true
}
```

### 字段说明

| 字段 | 必需 | 说明 |
|-----|------|------|
| `id` | ✓ | 插件唯一标识，小写字母和连字符 |
| `name` | ✓ | 插件显示名称 |
| `version` | ✓ | 版本号 |
| `description` | | 插件描述 |
| `author` | | 作者 |
| `requires` | | 版本要求，如 `>=0.1.1` |
| `hooks.frontend` | | 前端钩子列表 |
| `hooks.backend` | | 后端钩子列表（需要 backend.wasm） |
| `permissions` | | WASM 插件所需权限 |
| `shortcodes` | | 注册的短代码 |
| `settings` | | 是否有设置项 |

### 可用权限

| 权限 | 说明 |
|-----|------|
| `read_articles` | 读取文章数据 |
| `write_articles` | 修改文章数据 |
| `read_comments` | 读取评论数据 |
| `write_comments` | 修改评论数据 |
| `read_config` | 读取系统配置 |
| `write_config` | 修改系统配置 |
| `network` | 发起 HTTP 请求 |
| `fs_read` | 读取文件系统 |
| `fs_write` | 写入文件系统 |

## settings.json 配置

定义插件的可配置项，后台会自动生成设置界面。

```json
{
  "sections": [
    {
      "id": "general",
      "title": "基本设置",
      "fields": [
        {
          "id": "text_field",
          "type": "text",
          "label": "文本输入",
          "default": "默认值",
          "placeholder": "请输入...",
          "description": "字段说明"
        },
        {
          "id": "switch_field",
          "type": "switch",
          "label": "开关选项",
          "default": true
        },
        {
          "id": "select_field",
          "type": "select",
          "label": "下拉选择",
          "default": "option1",
          "options": [
            {"value": "option1", "label": "选项1"},
            {"value": "option2", "label": "选项2"}
          ]
        },
        {
          "id": "number_field",
          "type": "number",
          "label": "数字输入",
          "default": 50,
          "min": 0,
          "max": 100
        }
      ]
    }
  ]
}
```

### 支持的字段类型

| 类型 | 说明 | 额外属性 |
|-----|------|---------|
| `text` | 单行文本 | `placeholder`, `maxLength` |
| `textarea` | 多行文本 | `rows` |
| `number` | 数字 | `min`, `max`, `step` |
| `switch` | 开关 | - |
| `select` | 下拉选择 | `options` |
| `color` | 颜色选择器 | - |
| `image` | 图片上传 | - |
| `array` | 数组/列表 | `itemFields` |

### array 类型详解

`array` 类型用于创建可视化的列表编辑器，支持添加、删除、排序多个项目。

```json
{
  "id": "items",
  "type": "array",
  "label": "项目列表",
  "description": "可添加多个项目",
  "default": [],
  "itemFields": [
    { "id": "title", "label": "标题", "type": "text", "placeholder": "输入标题", "required": true },
    { "id": "url", "label": "链接", "type": "text", "placeholder": "https://..." },
    { "id": "sort", "label": "排序", "type": "number" }
  ]
}
```

#### itemFields 属性

| 属性 | 必需 | 说明 |
|-----|------|------|
| `id` | ✓ | 字段标识 |
| `label` | ✓ | 字段标签 |
| `type` | ✓ | 字段类型：`text` 或 `number` |
| `placeholder` | | 占位文字 |
| `required` | | 是否必填（显示 * 标记） |

#### 使用示例

**友链插件：**
```json
{
  "id": "links",
  "type": "array",
  "label": "友情链接",
  "itemFields": [
    { "id": "name", "label": "名称", "type": "text", "required": true },
    { "id": "url", "label": "链接", "type": "text", "required": true },
    { "id": "avatar", "label": "头像", "type": "text" },
    { "id": "description", "label": "描述", "type": "text" }
  ]
}
```

**轮播图插件：**
```json
{
  "id": "slides",
  "type": "array",
  "label": "轮播图",
  "itemFields": [
    { "id": "image", "label": "图片URL", "type": "text", "required": true },
    { "id": "title", "label": "标题", "type": "text" },
    { "id": "link", "label": "跳转链接", "type": "text" }
  ]
}
```

**社交链接插件：**
```json
{
  "id": "socials",
  "type": "array",
  "label": "社交链接",
  "itemFields": [
    { "id": "platform", "label": "平台", "type": "text", "placeholder": "GitHub" },
    { "id": "url", "label": "链接", "type": "text", "required": true },
    { "id": "icon", "label": "图标", "type": "text", "placeholder": "图标 class 或 URL" }
  ]
}
```

#### 前端获取数组数据

```javascript
const settings = Noteva.plugins.getSettings('my-plugin');
const items = settings.items || []; // 直接是数组，无需 JSON.parse

items.forEach(item => {
  console.log(item.title, item.url);
});
```

## frontend.js 开发

### 基本结构

```javascript
(function() {
  const PLUGIN_ID = 'my-plugin';
  
  // 等待 Noteva SDK 加载
  function waitForNoteva(callback) {
    if (typeof Noteva !== 'undefined') {
      callback();
    } else {
      setTimeout(() => waitForNoteva(callback), 100);
    }
  }
  
  waitForNoteva(function() {
    // 插件初始化代码
    init();
    
    console.log('[Plugin] my-plugin loaded');
  });
  
  function init() {
    // 获取插件设置
    const settings = Noteva.plugins.getSettings(PLUGIN_ID);
    
    // 你的逻辑...
  }
})();
```

### 获取插件设置

```javascript
const settings = Noteva.plugins.getSettings('my-plugin');
// 返回 settings.json 中定义的字段值
```

### 使用钩子

```javascript
// 内容渲染时触发
Noteva.hooks.on('content_render', (context) => {
  // context: { path, query }
  processContent();
});

// 评论创建后触发
Noteva.hooks.on('comment_after_create', (comment, context) => {
  // comment: 新创建的评论
  // context: { articleId }
  onCommentCreated(comment);
});

// 页面加载完成
Noteva.ready(() => {
  initPlugin();
});
```

### 常用钩子列表

| 钩子名 | 触发时机 | 参数 |
|-------|---------|------|
| `content_render` | 内容渲染时 | `{ path, query }` |
| `comment_before_create` | 评论提交前 | `data` |
| `comment_after_create` | 评论提交后 | `comment, { articleId }` |
| `body_end` | 页面加载完成 | - |

> 注意：v0.0.7 起移除了前台用户系统，`user_login_after` 和 `user_logout` 钩子仅在管理员登录/登出时触发。

### 使用事件

```javascript
// 监听主题就绪
Noteva.events.on('theme:ready', () => {
  createUI();
});

// 监听用户登录
Noteva.events.on('user:login', (user) => {
  updateUI(user);
});
```

### 调用 API

```javascript
// GET 请求
const data = await Noteva.api.get('/comments/1');

// POST 请求
const result = await Noteva.api.post('/comments', {
  article_id: 1,
  content: '评论内容'
});
```

### 用户相关

```javascript
// 检查登录状态
const user = await Noteva.user.check();

if (Noteva.user.isLoggedIn()) {
  const currentUser = Noteva.user.getCurrent();
  // { id, username, email, avatar, role }
}
```

### UI 工具

```javascript
// Toast 提示
Noteva.ui.toast('操作成功', 'success');
Noteva.ui.toast('操作失败', 'error');

// 确认对话框
const confirmed = await Noteva.ui.confirm('确定要执行吗？');

// 加载状态
Noteva.ui.showLoading();
Noteva.ui.hideLoading();
```

### 本地存储

```javascript
// 存储数据
Noteva.storage.set('my-plugin-data', { key: 'value' });

// 读取数据
const data = Noteva.storage.get('my-plugin-data');

// 删除数据
Noteva.storage.remove('my-plugin-data');
```

## Shortcode 开发

Shortcode 允许用户在文章中插入特殊内容。

### 后端处理

在 `plugin.json` 中声明 shortcode：

```json
{
  "shortcodes": ["hide-until-reply"]
}
```

后端会将 `[hide-until-reply]内容[/hide-until-reply]` 转换为 HTML。

### 前端处理

```javascript
// 处理渲染后的 shortcode 元素
Noteva.hooks.on('content_render', () => {
  const elements = document.querySelectorAll('.my-shortcode');
  elements.forEach(el => {
    // 处理元素
  });
});
```

## 完整示例：回复可见插件

### plugin.json

```json
{
  "id": "hide-until-reply",
  "name": "回复可见",
  "version": "1.0.0",
  "description": "部分内容需要回复后才能查看",
  "author": "Noteva",
  "hooks": {
    "frontend": ["content_render", "comment_after_create"]
  },
  "shortcodes": ["hide-until-reply"],
  "settings": true
}
```

### settings.json

```json
{
  "sections": [{
    "id": "general",
    "title": "基本设置",
    "fields": [
      {
        "id": "placeholder_text",
        "type": "text",
        "label": "占位文字",
        "default": "回复后可见"
      }
    ]
  }]
}
```

### frontend.js

```javascript
(function() {
  const PLUGIN_ID = 'hide-until-reply';
  
  function waitForNoteva(callback) {
    if (typeof Noteva !== 'undefined') callback();
    else setTimeout(() => waitForNoteva(callback), 100);
  }
  
  waitForNoteva(function() {
    // 检查用户是否已回复
    async function checkUnlocked(articleId) {
      const user = await Noteva.user.check();
      if (!user) return false;
      
      try {
        const result = await Noteva.api.get(`/comments/${articleId}`);
        const comments = result.comments || [];
        
        function hasUserComment(list) {
          for (const c of list) {
            if (c.user_id === user.id) return true;
            if (c.replies && hasUserComment(c.replies)) return true;
          }
          return false;
        }
        
        return hasUserComment(comments);
      } catch {
        return false;
      }
    }
    
    // 解锁内容
    function unlockContent(articleId) {
      const elements = document.querySelectorAll(
        `.noteva-hidden-content[data-article-id="${articleId}"]`
      );
      elements.forEach(el => {
        const template = el.querySelector('.noteva-hidden-template');
        if (template) {
          el.innerHTML = template.innerHTML;
          el.className = 'noteva-revealed-content';
        }
      });
    }
    
    // 初始化
    async function init() {
      const elements = document.querySelectorAll('.noteva-hidden-content');
      for (const el of elements) {
        const articleId = parseInt(el.dataset.articleId);
        if (articleId && await checkUnlocked(articleId)) {
          unlockContent(articleId);
        }
      }
    }
    
    // 监听内容渲染
    Noteva.hooks.on('content_render', () => {
      setTimeout(init, 100);
    });
    
    // 监听评论创建
    Noteva.hooks.on('comment_after_create', (comment, ctx) => {
      setTimeout(() => {
        unlockContent(ctx.articleId);
        Noteva.ui.toast('内容已解锁！', 'success');
      }, 500);
    });
    
    // 页面加载时初始化
    Noteva.ready(() => setTimeout(init, 500));
    
    console.log('[Plugin] hide-until-reply loaded');
  });
})();
```

### frontend.css

```css
.noteva-hidden-content {
  padding: 20px;
  background: #f5f5f5;
  border-radius: 8px;
  text-align: center;
  color: #666;
}

.noteva-revealed-content {
  padding: 16px;
  background: #f0fdf4;
  border-left: 4px solid #22c55e;
  border-radius: 4px;
}
```

## 完整示例：音乐播放器插件

### plugin.json

```json
{
  "id": "music-player",
  "name": "音乐播放器",
  "version": "2.0.0",
  "description": "黑胶唱片风格歌单播放器",
  "hooks": {
    "frontend": ["body_end"]
  },
  "settings": true
}
```

### settings.json

```json
{
  "sections": [
    {
      "id": "playlist",
      "title": "歌单设置",
      "fields": [
        {
          "id": "songs",
          "label": "歌曲列表",
          "type": "array",
          "description": "添加歌曲到播放列表",
          "default": [],
          "itemFields": [
            { "id": "name", "label": "歌曲名称", "type": "text", "placeholder": "歌曲名称" },
            { "id": "artist", "label": "歌手", "type": "text", "placeholder": "歌手" },
            { "id": "cover", "label": "封面URL", "type": "text", "placeholder": "封面 URL" },
            { "id": "url", "label": "音频URL", "type": "text", "placeholder": "音频 URL", "required": true }
          ]
        }
      ]
    },
    {
      "id": "playback",
      "title": "播放设置",
      "fields": [
        { "id": "autoplay", "type": "switch", "label": "自动播放", "default": false },
        { "id": "loop", "type": "switch", "label": "循环播放", "default": true },
        { "id": "volume", "type": "number", "label": "默认音量", "default": 50, "min": 0, "max": 100 }
      ]
    },
    {
      "id": "appearance",
      "title": "外观设置",
      "fields": [
        {
          "id": "position",
          "type": "select",
          "label": "播放器位置",
          "default": "bottom-right",
          "options": [
            { "value": "bottom-right", "label": "右下角" },
            { "value": "bottom-left", "label": "左下角" },
            { "value": "top-right", "label": "右上角" },
            { "value": "top-left", "label": "左上角" }
          ]
        }
      ]
    }
  ]
}
```

### frontend.js

```javascript
(function() {
  const PLUGIN_ID = 'music-player';
  const DEFAULT_COVER = 'data:image/svg+xml;base64,...'; // 默认封面
  
  let currentIndex = 0;
  let playlist = [];
  let audio = null;
  let isPlaying = false;
  
  function createPlayer() {
    const settings = Noteva.plugins.getSettings(PLUGIN_ID);
    // songs 直接是数组，无需 JSON.parse
    playlist = (settings.songs || []).filter(s => s.url);
    
    if (playlist.length === 0) return;
    
    const position = settings.position || 'bottom-right';
    const volume = (settings.volume || 50) / 100;
    
    const player = document.createElement('div');
    player.id = 'noteva-music-player';
    player.className = `music-player position-${position}`;
    
    const song = playlist[0];
    player.innerHTML = `
      <audio id="noteva-bg-music" preload="auto"></audio>
      <div class="player-disc-container">
        <div class="player-disc">
          <img class="disc-cover" src="${song.cover || DEFAULT_COVER}" alt="cover">
        </div>
      </div>
      <div class="player-info">
        <div class="song-name">${song.name || '未知歌曲'}</div>
        <div class="song-artist">${song.artist || '未知歌手'}</div>
      </div>
      <div class="player-controls">
        <button class="btn-prev">⏮</button>
        <button class="btn-play">▶</button>
        <button class="btn-next">⏭</button>
      </div>
    `;
    
    document.body.appendChild(player);
    
    audio = document.getElementById('noteva-bg-music');
    audio.volume = volume;
    audio.src = song.url;
    
    // 绑定事件...
  }
  
  Noteva.events.on('theme:ready', createPlayer);
})();
```

## 插件启用/禁用

插件状态保存在数据库 `plugin_states` 表中，通过后台管理界面启用/禁用。

启用带有 `backend.wasm` 的插件时，WASM 模块会自动加载到沙盒运行时；禁用时自动卸载。

## 调试技巧

1. 使用 `console.log` 输出调试信息
2. 检查浏览器控制台错误
3. 使用 `Noteva.debug.enable()` 开启调试模式
4. 检查网络请求确认 API 调用正确

## WASM 后端插件开发

WASM 后端插件在服务端沙盒中运行，可以参与后端钩子处理（如文章过滤、评论审核、内容转换等）。

### 工作原理

1. 插件目录中放置 `backend.wasm` 文件
2. `plugin.json` 中声明 `hooks.backend` 列表
3. 启用插件时，Noteva 自动加载 WASM 模块到 wasmtime 沙盒
4. 后端钩子触发时，自动调用 WASM 模块中对应的 `hook_xxx` 函数

### 使用 Rust 编写 WASM 插件

```rust
// src/lib.rs
use std::alloc::{alloc, Layout};

// 导出内存分配器供宿主使用
#[no_mangle]
pub extern "C" fn allocate(size: usize) -> *mut u8 {
    let layout = Layout::from_size_align(size, 1).unwrap();
    unsafe { alloc(layout) }
}

// 文章创建前的钩子 - 函数名必须是 hook_{钩子名}
#[no_mangle]
pub extern "C" fn hook_article_before_create() -> i32 {
    // 返回 0 表示成功，非 0 表示拒绝
    0
}

// 评论内容过滤钩子
#[no_mangle]
pub extern "C" fn hook_comment_content_filter() -> i32 {
    // 在这里实现敏感词过滤等逻辑
    0
}

// Markdown 渲染后处理
#[no_mangle]
pub extern "C" fn hook_markdown_after_parse() -> i32 {
    0
}
```

编译为 WASM：

```bash
# 添加 wasm32 target
rustup target add wasm32-unknown-unknown

# 编译
cargo build --target wasm32-unknown-unknown --release

# 复制到插件目录
cp target/wasm32-unknown-unknown/release/my_plugin.wasm plugins/my-plugin/backend.wasm
```

### Cargo.toml 配置

```toml
[package]
name = "my-plugin"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib"]

[profile.release]
opt-level = "s"      # 优化体积
lto = true
strip = true
```

### 可用的后端钩子

| 钩子名 | 触发时机 | 说明 |
|-------|---------|------|
| `article_before_create` | 文章创建前 | 可拦截或修改文章数据 |
| `article_after_create` | 文章创建后 | 通知类处理 |
| `article_before_update` | 文章更新前 | 可拦截或修改 |
| `article_after_update` | 文章更新后 | 通知类处理 |
| `article_before_delete` | 文章删除前 | 可拦截删除 |
| `article_after_delete` | 文章删除后 | 清理类处理 |
| `article_before_display` | 文章展示前 | 内容过滤/转换 |
| `article_content_filter` | 文章内容过滤 | 内容处理 |
| `comment_before_create` | 评论创建前 | 评论审核/过滤 |
| `comment_after_create` | 评论创建后 | 通知类处理 |
| `comment_content_filter` | 评论内容过滤 | 敏感词过滤等 |
| `markdown_before_parse` | Markdown 解析前 | 预处理 |
| `markdown_after_parse` | Markdown 解析后 | 后处理 |
| `user_login_before` | 用户登录前 | 登录拦截 |
| `user_login_after` | 用户登录后 | 登录通知 |
| `nav_items_filter` | 导航菜单过滤 | 动态修改导航 |

### 沙盒安全机制

WASM 插件运行在严格的沙盒环境中：

- **内存限制**：默认 16MB，防止内存泄漏
- **指令限制**：默认 100 万条指令（fuel），防止死循环
- **执行超时**：默认 5 秒超时
- **权限控制**：插件只能使用 `plugin.json` 中声明的权限
- **隔离运行**：每个插件独立运行，互不影响

### plugin.json 示例（WASM 插件）

```json
{
  "id": "content-filter",
  "name": "内容过滤器",
  "version": "1.0.0",
  "description": "自动过滤文章和评论中的敏感内容",
  "author": "Noteva Team",
  "requires": {
    "noteva": ">=0.1.1"
  },
  "hooks": {
    "backend": [
      "article_content_filter",
      "comment_content_filter"
    ]
  },
  "permissions": [
    "read_articles",
    "read_comments"
  ],
  "settings": true
}
```

### 管理 API

```
GET  /api/v1/plugins/wasm/status    # 查看 WASM 运行时状态
```

返回示例：
```json
{
  "runtime_active": true,
  "loaded_count": 1,
  "loaded_plugins": [
    {
      "name": "内容过滤器",
      "version": "1.0.0",
      "permissions": ["read_articles", "read_comments"]
    }
  ],
  "wasm_capable_plugins": ["content-filter"]
}
```

## 注意事项

1. **等待 SDK 加载** - 使用 `waitForNoteva` 或 `Noteva.ready()`
2. **异步操作** - `Noteva.user.check()` 是异步的，需要 await
3. **DOM 时机** - React 等框架渲染需要时间，适当延迟处理
4. **插件 ID** - 必须与目录名一致
5. **设置缓存** - 修改设置后可能需要刷新页面
