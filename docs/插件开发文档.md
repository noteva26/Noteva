# Noteva æ’ä»¶å¼€å‘æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv0.1.4-beta

## å¿«é€Ÿå¼€å§‹

Noteva æ’ä»¶ç³»ç»Ÿå…è®¸ä½ æ‰©å±•åšå®¢åŠŸèƒ½ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚

æ”¯æŒä¸¤ç§æ’ä»¶ç±»å‹ï¼š
- **å‰ç«¯æ’ä»¶**ï¼šé€šè¿‡ JavaScript/CSS åœ¨æµè§ˆå™¨ç«¯è¿è¡Œï¼Œä½¿ç”¨ Noteva SDK
- **WASM åç«¯æ’ä»¶**ï¼šé€šè¿‡ WebAssembly åœ¨æœåŠ¡ç«¯æ²™ç›’ä¸­è¿è¡Œï¼Œå¯å‚ä¸åç«¯é’©å­å¤„ç†

### æ’ä»¶ç›®å½•ç»“æ„

```
plugins/
  my-plugin/
    plugin.json        # æ’ä»¶é…ç½®ï¼ˆå¿…éœ€ï¼‰
    frontend.js        # å‰ç«¯è„šæœ¬ï¼ˆå¯é€‰ï¼‰
    frontend.css       # å‰ç«¯æ ·å¼ï¼ˆå¯é€‰ï¼‰
    backend.wasm       # WASM åç«¯æ¨¡å—ï¼ˆå¯é€‰ï¼‰
    settings.json      # è®¾ç½®é¡¹å®šä¹‰ï¼ˆå¯é€‰ï¼‰
    editor.json        # ç¼–è¾‘å™¨å·¥å…·æ æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
    locales/           # å›½é™…åŒ–ç¿»è¯‘æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
      zh-CN.json
      en.json
    README.md          # æ’ä»¶è¯´æ˜ï¼ˆå¯é€‰ï¼‰
```

---

## plugin.json é…ç½®

```json
{
  "id": "my-plugin",
  "name": "æˆ‘çš„æ’ä»¶",
  "version": "1.0.0",
  "description": "æ’ä»¶æè¿°",
  "author": "Your Name",
  "license": "MIT",
  "requires": {
    "noteva": ">=0.1.3"
  },
  "hooks": {
    "frontend": ["content_render"],
    "backend": ["article_after_create", "plugin_activate", "plugin_action"]
  },
  "permissions": ["network", "storage", "read_articles"],
  "shortcodes": [],
  "settings": true
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | å¿…éœ€ | è¯´æ˜ |
|-----|------|------|
| `id` | æ˜¯ | æ’ä»¶å”¯ä¸€æ ‡è¯†ï¼Œå°å†™å­—æ¯å’Œè¿å­—ç¬¦ï¼Œå¿…é¡»ä¸ç›®å½•åä¸€è‡´ |
| `name` | æ˜¯ | æ’ä»¶æ˜¾ç¤ºåç§° |
| `version` | æ˜¯ | ç‰ˆæœ¬å·ï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼‰ |
| `description` | | æ’ä»¶æè¿° |
| `author` | | ä½œè€… |
| `license` | | å¼€æºåè®® |
| `requires.noteva` | | æœ€ä½ç‰ˆæœ¬è¦æ±‚ï¼Œå¦‚ `>=0.1.3` |
| `hooks.frontend` | | å‰ç«¯é’©å­åˆ—è¡¨ |
| `hooks.backend` | | åç«¯é’©å­åˆ—è¡¨ï¼ˆéœ€è¦ backend.wasmï¼‰ |
| `hooks.editor` | | ç¼–è¾‘å™¨æ‰©å±•ï¼Œå¦‚ `["toolbar"]`ï¼ˆéœ€è¦ editor.jsonï¼‰ |
| `permissions` | | WASM æ’ä»¶æ‰€éœ€æƒé™åˆ—è¡¨ |
| `shortcodes` | | æ³¨å†Œçš„çŸ­ä»£ç åˆ—è¡¨ |
| `settings` | | æ˜¯å¦æœ‰è®¾ç½®é¡¹ï¼ˆtrue/falseï¼‰ |

### å¯ç”¨æƒé™

| æƒé™ | è¯´æ˜ |
|-----|------|
| `network` | å‘èµ· HTTP è¯·æ±‚ï¼ˆè°ƒç”¨å¤–éƒ¨ APIï¼‰ |
| `storage` | æ’ä»¶æ•°æ®å­˜å‚¨ï¼ˆkey-valueï¼ŒæŒ‰æ’ä»¶ ID éš”ç¦»ï¼‰ |
| `read_articles` | æŸ¥è¯¢æ–‡ç« åˆ—è¡¨ï¼ˆç”¨äºæ‰¹é‡å¤„ç†ç­‰åœºæ™¯ï¼‰ |
| `read_comments` | è¯»å–è¯„è®ºæ•°æ® |
| `write_articles` | ä¿®æ”¹æ–‡ç« æ•°æ® |
| `write_comments` | ä¿®æ”¹è¯„è®ºæ•°æ® |
| `read_config` | è¯»å–ç³»ç»Ÿé…ç½® |
| `write_config` | ä¿®æ”¹ç³»ç»Ÿé…ç½® |
| `fs_read` | è¯»å–æ–‡ä»¶ç³»ç»Ÿ |
| `fs_write` | å†™å…¥æ–‡ä»¶ç³»ç»Ÿ |

> `storage` æƒé™ä¼šè‡ªåŠ¨æˆäºˆæ‰€æœ‰ WASM æ’ä»¶ï¼Œä½†å»ºè®®æ˜¾å¼å£°æ˜ä»¥ä¿æŒæ¸…æ™°ã€‚

---

## settings.json é…ç½®

å®šä¹‰æ’ä»¶çš„å¯é…ç½®é¡¹ï¼Œåå°ä¼šè‡ªåŠ¨ç”Ÿæˆè®¾ç½®ç•Œé¢ã€‚

```json
{
  "sections": [
    {
      "id": "api",
      "title": "API é…ç½®",
      "fields": [
        {
          "id": "api_url",
          "type": "text",
          "label": "API åœ°å€",
          "default": "https://api.example.com",
          "placeholder": "https://..."
        },
        {
          "id": "api_key",
          "type": "text",
          "label": "API Key",
          "default": "",
          "placeholder": "sk-...",
          "secret": true
        }
      ]
    },
    {
      "id": "display",
      "title": "æ˜¾ç¤ºè®¾ç½®",
      "fields": [
        {
          "id": "enabled",
          "type": "switch",
          "label": "å¯ç”¨åŠŸèƒ½",
          "default": true
        },
        {
          "id": "max_count",
          "type": "number",
          "label": "æœ€å¤§æ•°é‡",
          "default": 10,
          "min": 1,
          "max": 100
        }
      ]
    }
  ]
}
```

### æ”¯æŒçš„å­—æ®µç±»å‹

| ç±»å‹ | è¯´æ˜ | é¢å¤–å±æ€§ |
|-----|------|---------|
| `text` | å•è¡Œæ–‡æœ¬ | `placeholder`, `maxLength`, `secret` |
| `textarea` | å¤šè¡Œæ–‡æœ¬ | `rows` |
| `number` | æ•°å­— | `min`, `max`, `step` |
| `switch` | å¼€å…³ | - |
| `select` | ä¸‹æ‹‰é€‰æ‹© | `options` |
| `color` | é¢œè‰²é€‰æ‹©å™¨ | - |
| `image` | å›¾ç‰‡ä¸Šä¼  | - |
| `array` | æ•°ç»„/åˆ—è¡¨ | `itemFields` |

### secret å­—æ®µ

åœ¨å­—æ®µå®šä¹‰ä¸­æ·»åŠ  `"secret": true`ï¼Œè¯¥å­—æ®µçš„å€¼ä¸ä¼šå‡ºç°åœ¨å…¬å¼€ APIï¼ˆ`GET /plugins/enabled`ï¼‰çš„å“åº”ä¸­ã€‚é€‚ç”¨äº API Keyã€å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ã€‚

- å…¬å¼€ APIï¼šsecret å­—æ®µè¢«è¿‡æ»¤ï¼Œå‰ç«¯æ— æ³•è·å–
- WASM é’©å­ï¼šsecret å­—æ®µæ­£å¸¸æ³¨å…¥ï¼ˆåç«¯éœ€è¦ä½¿ç”¨ï¼‰
- Action API å“åº”ï¼šæ‰€æœ‰æ’ä»¶è®¾ç½®å­—æ®µè‡ªåŠ¨å‰¥ç¦»

### array ç±»å‹

ç”¨äºåˆ›å»ºå¯è§†åŒ–çš„åˆ—è¡¨ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ·»åŠ ã€åˆ é™¤ã€æ’åºã€‚

```json
{
  "id": "links",
  "type": "array",
  "label": "å‹æƒ…é“¾æ¥",
  "default": [],
  "itemFields": [
    { "id": "name", "label": "åç§°", "type": "text", "required": true },
    { "id": "url", "label": "é“¾æ¥", "type": "text", "required": true },
    { "id": "avatar", "label": "å¤´åƒ", "type": "text" }
  ]
}
```

å‰ç«¯è·å–ï¼š`Noteva.plugins.getSettings('my-plugin').links` ç›´æ¥æ˜¯æ•°ç»„ã€‚

---

## editor.json ç¼–è¾‘å™¨å·¥å…·æ é…ç½®

æ’ä»¶å¯ä»¥åœ¨ç®¡ç†åå°çš„ Markdown ç¼–è¾‘å™¨å·¥å…·æ ä¸­æ³¨å†ŒæŒ‰é’®ï¼Œç»Ÿä¸€æ”¶çº³åœ¨ âŠ• ä¸‹æ‹‰èœå•ä¸­ã€‚

### é…ç½®æ–¹å¼

åœ¨æ’ä»¶ç›®å½•ä¸‹åˆ›å»º `editor.json`ï¼Œå¹¶åœ¨ `plugin.json` ä¸­å£°æ˜ï¼š

```json
{
  "hooks": {
    "editor": ["toolbar"]
  }
}
```

### editor.json æ ¼å¼

```json
{
  "toolbar": [
    {
      "id": "my-button",
      "label": "æŒ‰é’®åç§°",
      "icon": "ğŸ”’",
      "insertBefore": "[shortcode]",
      "insertAfter": "[/shortcode]"
    }
  ]
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | å¿…éœ€ | è¯´æ˜ |
|-----|------|------|
| `id` | æ˜¯ | æŒ‰é’®å”¯ä¸€æ ‡è¯† |
| `label` | æ˜¯ | æŒ‰é’®æ˜¾ç¤ºæ–‡å­—ï¼ˆä¸‹æ‹‰èœå•ä¸­æ˜¾ç¤ºï¼‰ |
| `icon` | å¦ | Emoji å›¾æ ‡ï¼Œæ˜¾ç¤ºåœ¨ label å‰é¢ã€‚æ—  icon æ—¶æ˜¾ç¤ºé»˜è®¤å›¾æ ‡ |
| `insertBefore` | æ˜¯ | ç‚¹å‡»ååœ¨å…‰æ ‡å‰ï¼ˆæˆ–é€‰ä¸­æ–‡æœ¬å‰ï¼‰æ’å…¥çš„æ–‡æœ¬ |
| `insertAfter` | æ˜¯ | ç‚¹å‡»ååœ¨å…‰æ ‡åï¼ˆæˆ–é€‰ä¸­æ–‡æœ¬åï¼‰æ’å…¥çš„æ–‡æœ¬ |

### å·¥ä½œåŸç†

1. åç«¯ `Plugin::get_editor_config()` è¯»å–æ’ä»¶ç›®å½•ä¸‹çš„ `editor.json`
2. é€šè¿‡ `GET /api/v1/plugins/enabled` æ¥å£è¿”å›å„æ’ä»¶çš„ `editor_config`
3. å‰ç«¯ç¼–è¾‘å™¨æ”¶é›†æ‰€æœ‰æ’ä»¶çš„ toolbar æŒ‰é’®ï¼Œæ¸²æŸ“åˆ° âŠ• ä¸‹æ‹‰èœå•ä¸­
4. æ²¡æœ‰ä»»ä½•æ’ä»¶æ³¨å†Œ toolbar æŒ‰é’®æ—¶ï¼ŒâŠ• æŒ‰é’®ä¸æ˜¾ç¤º

### ç¤ºä¾‹

å›å¤å¯è§æ’ä»¶ï¼ˆhide-until-replyï¼‰ï¼š

```json
{
  "toolbar": [
    {
      "id": "hide-until-reply",
      "label": "å›å¤å¯è§",
      "icon": "ğŸ”’",
      "insertBefore": "[hide-until-reply]\n",
      "insertAfter": "\n[/hide-until-reply]"
    }
  ]
}
```

åª’ä½“æ’­æ”¾å™¨æ’ä»¶ï¼ˆmedia-playerï¼‰ï¼š

```json
{
  "toolbar": [
    {
      "id": "insert-video",
      "label": "æ’å…¥è§†é¢‘",
      "icon": "ğŸ¬",
      "insertBefore": "[video src=\"",
      "insertAfter": "\" /]"
    },
    {
      "id": "insert-audio",
      "label": "æ’å…¥éŸ³é¢‘",
      "icon": "ğŸµ",
      "insertBefore": "[audio src=\"",
      "insertAfter": "\" /]"
    }
  ]
}
```

> ä¸€ä¸ªæ’ä»¶å¯ä»¥æ³¨å†Œå¤šä¸ªå·¥å…·æ æŒ‰é’®ã€‚æ–°å»ºæ–‡ç« å’Œç¼–è¾‘æ–‡ç« é¡µé¢éƒ½æ”¯æŒæ’ä»¶å·¥å…·æ ã€‚

---

## å‰ç«¯æ’ä»¶å¼€å‘ï¼ˆfrontend.jsï¼‰

### åŸºæœ¬ç»“æ„

```javascript
(function() {
  const PLUGIN_ID = 'my-plugin';

  function waitForNoteva(callback) {
    if (typeof Noteva !== 'undefined') callback();
    else setTimeout(function() { waitForNoteva(callback); }, 100);
  }

  waitForNoteva(function() {
    var settings = Noteva.plugins.getSettings(PLUGIN_ID);

    // æ³¨æ„ï¼šgetSettings è¿”å›ä»æ•°æ®åº“åŠ è½½çš„è®¾ç½®
    // å¦‚æœç”¨æˆ·ä»æœªä¿å­˜è¿‡è®¾ç½®ï¼Œè¿”å›ç©ºå¯¹è±¡ {}
    // æ£€æŸ¥å¼€å…³ç±»è®¾ç½®æ—¶ï¼Œåº”ä½¿ç”¨ === false è€Œé !value
    if (settings.enabled === false) return;

    // æ’ä»¶é€»è¾‘...

    console.log('[Plugin] my-plugin loaded');
  });
})();
```

### å‰ç«¯é’©å­

| é’©å­å | ç±»å‹ | è§¦å‘æ—¶æœº | å‚æ•° |
|-------|------|---------|------|
| `article_view` | Action | ä¸»é¢˜åŠ è½½æ–‡ç« æ—¶ | `article` å®Œæ•´æ–‡ç« å¯¹è±¡ |
| `content_render` | Action | SPA è·¯ç”±å˜åŒ–/DOM å˜åŒ–æ—¶ | `{ path, query }` |
| `comment_after_create` | Action | è¯„è®ºæäº¤å | `comment, { articleId }` |
| `body_end` | Action | é¡µé¢åŠ è½½å®Œæˆ | - |
| `seo_meta_tags` | Filter | SEO å…ƒæ ‡ç­¾ç”Ÿæˆæ—¶ | `{ title, description, keywords }` |
| `admin_menu` | Filter | ç®¡ç†åå°èœå•æ¸²æŸ“æ—¶ | `{ items }` |
| `admin_dashboard` | Filter | ç®¡ç†åå°ä»ªè¡¨ç›˜æ¸²æŸ“æ—¶ | `{ widgets }` |
| `nav_items_filter` | Filter | å¯¼èˆªèœå•æ¸²æŸ“æ—¶ | `{ items }` |

```javascript
// æ–‡ç« æŸ¥çœ‹ï¼ˆæœ€å¸¸ç”¨ï¼Œå¯è·å–æ–‡ç«  IDï¼‰
Noteva.hooks.on('article_view', function(article) {
  // article: { id, slug, title, content, content_html, ... }
  console.log('Viewing article:', article.id, article.title);
});

// å†…å®¹æ¸²æŸ“ï¼ˆSPA å¯¼èˆªæ—¶è‡ªåŠ¨è§¦å‘ï¼‰
Noteva.hooks.on('content_render', function(context) {
  // context: { path, query }
});

// é¡µé¢åŠ è½½å®Œæˆ
Noteva.ready(function() {
  // åˆå§‹åŒ–
});
```

### è·¯ç”±åŒ¹é…

```javascript
var match = Noteva.router.match('/posts/:slug');
if (match.matched) {
  var slug = match.params.slug;
  // å½“å‰åœ¨æ–‡ç« é¡µ
}
```

### æ’ä»¶æ•°æ® APIï¼ˆå…¬å¼€ï¼‰

è¯»å–åç«¯ WASM æ’ä»¶å­˜å‚¨çš„æ•°æ®ï¼Œæ— éœ€ç™»å½•ï¼š

```javascript
// SDK æ–¹å¼
var value = await Noteva.plugins.getData('my-plugin', 'some-key');

// æˆ–ç›´æ¥ fetch
fetch('/api/v1/plugins/my-plugin/data/some-key')
  .then(function(r) { return r.json(); })
  .then(function(d) { console.log(d.value); });
```

### æ’ä»¶ Action APIï¼ˆéœ€ç®¡ç†å‘˜ç™»å½•ï¼‰

è§¦å‘æ’ä»¶çš„è‡ªå®šä¹‰åç«¯æ“ä½œï¼š

```javascript
fetch('/api/v1/admin/plugins/my-plugin/action/regenerate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  credentials: 'include',
  body: JSON.stringify({ article_id: 123 })
})
  .then(function(r) { return r.json(); })
  .then(function(d) {
    // d: { success: true, data: { ... } }
  });
```

> Action API åœ¨ `/admin/` è·¯å¾„ä¸‹ï¼Œå— `require_admin` + `require_auth` ä¸­é—´ä»¶ä¿æŠ¤ã€‚

### æ’ä»¶æ³¨å…¥ç‚¹ï¼ˆPluginSlotï¼‰

ä¸»é¢˜ä¸­é¢„ç•™äº†å¤šä¸ªæ³¨å…¥ç‚¹ï¼š

| æ³¨å…¥ç‚¹ | ä½ç½® |
|-------|------|
| `body_start` | é¡µé¢é¡¶éƒ¨ |
| `body_end` | é¡µé¢åº•éƒ¨ |
| `article_content_top` | æ–‡ç« å†…å®¹é¡¶éƒ¨ |
| `article_content_bottom` | æ–‡ç« å†…å®¹åº•éƒ¨ |
| `article_after_content` | æ–‡ç« å¡ç‰‡ä¸‹æ–¹ |
| `comment_form_before` | è¯„è®ºè¡¨å•ä¸Šæ–¹ |
| `comment_form_after` | è¯„è®ºè¡¨å•ä¸‹æ–¹ |

```javascript
// æ–¹å¼ä¸€ï¼šSDK slotsï¼ˆé™æ€ HTMLï¼‰
Noteva.slots.register('article_content_top', '<div>å†…å®¹</div>', 10);

// æ–¹å¼äºŒï¼šDOM æ“ä½œï¼ˆåŠ¨æ€å†…å®¹ï¼‰
var slot = document.querySelector('[data-noteva-slot="article_content_top"]');
if (slot) slot.appendChild(myElement);
```

### ç”¨æˆ·çŠ¶æ€

```javascript
var user = await Noteva.user.check();
if (Noteva.user.isLoggedIn()) {
  var current = Noteva.user.getCurrent();
  // { id, username, email, avatar, role }
  if (current.role === 'admin') {
    // ç®¡ç†å‘˜ä¸“å±åŠŸèƒ½
  }
}
```

### UI å·¥å…·

```javascript
Noteva.ui.toast('æ“ä½œæˆåŠŸ', 'success');
Noteva.ui.toast('æ“ä½œå¤±è´¥', 'error');
var confirmed = await Noteva.ui.confirm('ç¡®å®šè¦æ‰§è¡Œå—ï¼Ÿ');
```

### æš—è‰²æ¨¡å¼é€‚é…

ä¸»é¢˜ä½¿ç”¨ class-based æš—è‰²æ¨¡å¼ï¼ˆ`<html class="dark">`ï¼‰ï¼ŒCSS åº”ä½¿ç”¨ `.dark` é€‰æ‹©å™¨ï¼š

```css
.my-plugin-box {
  background: #f0f9ff;
  color: #334155;
}

.dark .my-plugin-box {
  background: #0f172a;
  color: #cbd5e1;
}
```

> ä¸è¦ä½¿ç”¨ `@media (prefers-color-scheme: dark)`ï¼Œå®ƒä¸ä¼šè·Ÿéšä¸»é¢˜åˆ‡æ¢ã€‚

---

## WASM åç«¯æ’ä»¶å¼€å‘

WASM åç«¯æ’ä»¶åœ¨æœåŠ¡ç«¯æ²™ç›’ä¸­è¿è¡Œï¼Œé€šè¿‡å­è¿›ç¨‹éš”ç¦»ï¼ˆwasm-workerï¼‰ï¼Œæ’ä»¶å´©æºƒä¸ä¼šå½±å“ä¸»ç¨‹åºã€‚

### æ¶æ„

```
ä¸»ç¨‹åº (noteva)
  |
  +-- é’©å­è§¦å‘ -> ç”Ÿæˆ JSON è¾“å…¥ï¼ˆè‡ªåŠ¨æ³¨å…¥æ’ä»¶è®¾ç½®ï¼‰
  |
  +-- å¯åŠ¨å­è¿›ç¨‹ (wasm-worker)
  |     +-- åŠ è½½ backend.wasm
  |     +-- æ³¨å†Œå®¿ä¸»å‡½æ•°ï¼ˆç½‘ç»œã€å­˜å‚¨ã€æ—¥å¿—ã€æ–‡ç« æŸ¥è¯¢ï¼‰
  |     +-- è°ƒç”¨ hook_xxx(ptr, len) -> result_ptr
  |     +-- è¿”å› JSON ç»“æœ + å­˜å‚¨æ“ä½œåˆ—è¡¨
  |
  +-- æ‰§è¡Œå­˜å‚¨æ“ä½œ -> å†™å…¥æ•°æ®åº“
```

å…³é”®ç‰¹æ€§ï¼š
- æ’ä»¶è®¾ç½®è‡ªåŠ¨æ³¨å…¥åˆ°é’©å­è¾“å…¥æ•°æ®ä¸­ï¼Œæ— éœ€æ‰‹åŠ¨è¯»å–é…ç½®
- å­˜å‚¨æ“ä½œåœ¨å­è¿›ç¨‹ç»“æŸåç”±ä¸»ç¨‹åºæ‰¹é‡æ‰§è¡Œï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
- æ¯æ¬¡é’©å­è°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹çš„å­è¿›ç¨‹ï¼Œæ— çŠ¶æ€
- æ’ä»¶å´©æºƒï¼ˆpanicã€å†…å­˜è¶Šç•Œç­‰ï¼‰åªå½±å“å­è¿›ç¨‹ï¼Œä¸»ç¨‹åºä¸å—å½±å“

### ç¼–è¯‘

æ¨èä½¿ç”¨ `wasm32-wasip1` ç›®æ ‡ï¼ˆæ”¯æŒæ ‡å‡†åº“ï¼‰ï¼š

```bash
# å®‰è£…ç¼–è¯‘ç›®æ ‡ï¼ˆä¸€æ¬¡æ€§ï¼‰
rustup target add wasm32-wasip1

# ç¼–è¯‘
cargo build --release --target wasm32-wasip1

# å¤åˆ¶åˆ°æ’ä»¶ç›®å½•
cp target/wasm32-wasip1/release/my_plugin.wasm plugins/my-plugin/backend.wasm
```

Cargo.tomlï¼š

```toml
[package]
name = "my-plugin"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib"]

[profile.release]
opt-level = "s"
lto = true
strip = true
```

> ä¸éœ€è¦ä»»ä½•å¤–éƒ¨ä¾èµ–ã€‚å®¿ä¸»å‡½æ•°é€šè¿‡ `extern "C"` å£°æ˜ï¼ŒJSON æ‰‹åŠ¨è§£æå³å¯ã€‚

### å®¿ä¸»å‡½æ•°

æ‰€æœ‰å®¿ä¸»å‡½æ•°åœ¨ `"env"` æ¨¡å—ä¸‹æ³¨å†Œï¼ŒWASM æ’ä»¶é€šè¿‡ `extern "C"` å£°æ˜ä½¿ç”¨ã€‚

**æ‰€æœ‰å®¿ä¸»å‡½æ•°éƒ½å¿…é¡»å£°æ˜**ï¼Œå³ä½¿ä¸ä½¿ç”¨ã€‚WASM æ¨¡å—åœ¨ç¼–è¯‘æ—¶å£°æ˜æ‰€æœ‰å¯¼å…¥ï¼Œå®ä¾‹åŒ–æ—¶å¦‚æœç¼ºå°‘ä»»ä½•ä¸€ä¸ªéƒ½ä¼šå¤±è´¥ã€‚æƒé™æ£€æŸ¥åœ¨å‡½æ•°ä½“å†…éƒ¨è¿›è¡Œâ€”â€”æ— æƒé™æ—¶è¿”å› 0 æˆ–ç©ºç»“æœï¼Œä¸ä¼šå¯¼è‡´ trapã€‚

```rust
extern "C" {
    // æ—¥å¿—è¾“å‡ºï¼ˆæ— éœ€æƒé™ï¼‰
    fn host_log(level_ptr: i32, level_len: i32, msg_ptr: i32, msg_len: i32);

    // HTTP è¯·æ±‚ï¼ˆéœ€è¦ network æƒé™ï¼‰
    fn host_http_request(
        method_ptr: i32, method_len: i32,
        url_ptr: i32, url_len: i32,
        headers_ptr: i32, headers_len: i32,
        body_ptr: i32, body_len: i32,
    ) -> i32;

    // å­˜å‚¨æ“ä½œï¼ˆéœ€è¦ storage æƒé™ï¼Œè‡ªåŠ¨æˆäºˆï¼‰
    fn host_storage_get(key_ptr: i32, key_len: i32) -> i32;
    fn host_storage_set(key_ptr: i32, key_len: i32, value_ptr: i32, value_len: i32) -> i32;
    fn host_storage_delete(key_ptr: i32, key_len: i32) -> i32;

    // æ–‡ç« æŸ¥è¯¢ï¼ˆéœ€è¦ read_articles æƒé™ï¼‰
    fn host_query_articles(filter_ptr: i32, filter_len: i32) -> i32;
    fn host_get_article(id_ptr: i32, id_len: i32) -> i32;

    // è¯„è®ºæŸ¥è¯¢ï¼ˆéœ€è¦ read_comments æƒé™ï¼‰
    fn host_get_comments(article_id_ptr: i32, article_id_len: i32) -> i32;

    // æ–‡ç« å…ƒæ•°æ®æ›´æ–°ï¼ˆéœ€è¦ write_articles æƒé™ï¼‰
    fn host_update_article_meta(article_id: i32, data_ptr: i32, data_len: i32) -> i32;
}
```

#### host_log

è¾“å‡ºæ—¥å¿—åˆ°ä¸»æœåŠ¡å™¨ã€‚level æ”¯æŒ `"info"`, `"warn"`, `"error"`ã€‚

```rust
fn log(level: &str, msg: &str) {
    unsafe {
        host_log(
            level.as_ptr() as i32, level.len() as i32,
            msg.as_ptr() as i32, msg.len() as i32,
        );
    }
}

// ä½¿ç”¨
log("info", "Processing article...");
```

æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼š`[wasm:plugin-id][level] message`

#### host_http_request

å‘èµ· HTTP è¯·æ±‚ã€‚æ”¯æŒ GET/POST/PUT/DELETE/PATCHã€‚

- è¶…æ—¶ï¼š10 ç§’
- å“åº”ä½“é™åˆ¶ï¼š1 MB
- è¿”å›å€¼ï¼šæŒ‡å‘å“åº” JSON çš„å†…å­˜æŒ‡é’ˆï¼ˆ4 å­—èŠ‚é•¿åº¦å‰ç¼€ + JSON å­—èŠ‚ï¼‰
- è¿”å› 0 è¡¨ç¤ºå¤±è´¥

å“åº” JSON æ ¼å¼ï¼š`{"status": 200, "body": "å“åº”å†…å®¹"}`

```rust
fn http_post(url: &str, headers: &str, body: &[u8]) -> Option<String> {
    let method = "POST";
    let result_ptr = unsafe {
        host_http_request(
            method.as_ptr() as i32, method.len() as i32,
            url.as_ptr() as i32, url.len() as i32,
            headers.as_ptr() as i32, headers.len() as i32,
            body.as_ptr() as i32, body.len() as i32,
        )
    };
    if result_ptr <= 0 { return None; }
    read_result(result_ptr) // è¯»å– 4 å­—èŠ‚é•¿åº¦å‰ç¼€ + JSON
}
```

#### host_storage_get / set / delete

æ’ä»¶æ•°æ®å­˜å‚¨ï¼ŒæŒ‰æ’ä»¶ ID è‡ªåŠ¨éš”ç¦»ã€‚

- `get`ï¼šè¿”å› JSON `{"found": true, "value": "..."}` æˆ– `{"found": false, "value": ""}`
- `set`ï¼šè¿”å› > 0 è¡¨ç¤ºæˆåŠŸ
- `delete`ï¼šè¿”å› > 0 è¡¨ç¤ºæˆåŠŸ

```rust
fn storage_get(key: &str) -> Option<String> {
    let result_ptr = unsafe {
        host_storage_get(key.as_ptr() as i32, key.len() as i32)
    };
    if result_ptr <= 0 { return None; }
    let json = read_result(result_ptr)?;
    if !json.contains("\"found\":true") { return None; }
    extract_json_string(&json, "value")
}

fn storage_set(key: &str, value: &str) -> bool {
    unsafe {
        host_storage_set(
            key.as_ptr() as i32, key.len() as i32,
            value.as_ptr() as i32, value.len() as i32,
        ) > 0
    }
}

fn storage_delete(key: &str) -> bool {
    unsafe {
        host_storage_delete(key.as_ptr() as i32, key.len() as i32) > 0
    }
}
```

å­˜å‚¨çš„æ•°æ®å¯é€šè¿‡å…¬å¼€ API è¯»å–ï¼š`GET /api/v1/plugins/{plugin_id}/data/{key}`

#### host_query_articles

æŸ¥è¯¢æ‰€æœ‰å·²å‘å¸ƒæ–‡ç« ã€‚è¿”å› JSON æ•°ç»„å­—ç¬¦ä¸²ã€‚

```rust
fn query_articles() -> Option<String> {
    let filter = "{}";
    let result_ptr = unsafe {
        host_query_articles(filter.as_ptr() as i32, filter.len() as i32)
    };
    if result_ptr <= 0 { return None; }
    read_result(result_ptr)
}
// è¿”å›: [{"id":1,"title":"...","slug":"...","content":"..."}, ...]
```

#### host_get_article

æ ¹æ®æ–‡ç«  ID æŸ¥è¯¢å•ç¯‡æ–‡ç« ã€‚éœ€è¦ `read_articles` æƒé™ã€‚è¿”å›å•ç¯‡æ–‡ç« çš„ JSON å­—ç¬¦ä¸²ï¼Œæ‰¾ä¸åˆ°æ—¶è¿”å› `null`ã€‚

```rust
extern "C" {
    fn host_get_article(id_ptr: i32, id_len: i32) -> i32;
}

fn get_article(id: i64) -> Option<String> {
    let id_str = id.to_string();
    let result_ptr = unsafe {
        host_get_article(id_str.as_ptr() as i32, id_str.len() as i32)
    };
    if result_ptr <= 0 { return None; }
    read_result(result_ptr)
}
// è¿”å›: {"id":1,"title":"...","slug":"...","content":"...","content_html":"..."}
// æ‰¾ä¸åˆ°æ—¶è¿”å›: "null"
```

#### host_get_comments

æŸ¥è¯¢æŒ‡å®šæ–‡ç« çš„è¯„è®ºåˆ—è¡¨ã€‚éœ€è¦ `read_comments` æƒé™ã€‚è¿”å›è¯„è®º JSON æ•°ç»„å­—ç¬¦ä¸²ã€‚

```rust
extern "C" {
    fn host_get_comments(article_id_ptr: i32, article_id_len: i32) -> i32;
}

fn get_comments(article_id: i64) -> Option<String> {
    let id_str = article_id.to_string();
    let result_ptr = unsafe {
        host_get_comments(id_str.as_ptr() as i32, id_str.len() as i32)
    };
    if result_ptr <= 0 { return None; }
    read_result(result_ptr)
}
// è¿”å›: [{"id":1,"content":"...","author_name":"...","created_at":"..."}, ...]
```

> **æƒé™è¯´æ˜**ï¼š`host_get_article` éœ€è¦åœ¨ `plugin.json` ä¸­å£°æ˜ `read_articles` æƒé™ï¼Œ`host_get_comments` éœ€è¦å£°æ˜ `read_comments` æƒé™ã€‚

#### host_update_article_meta

æ›´æ–°æ–‡ç« çš„æ’ä»¶å…ƒæ•°æ®ã€‚éœ€è¦ `write_articles` æƒé™ã€‚æ•°æ®ä¼šå­˜å‚¨åœ¨æ–‡ç« çš„ `meta` JSON å­—æ®µä¸­ï¼ŒæŒ‰æ’ä»¶ ID è‡ªåŠ¨éš”ç¦»å‘½åç©ºé—´ã€‚

```rust
extern "C" {
    fn host_update_article_meta(article_id: i32, data_ptr: i32, data_len: i32) -> i32;
}

fn update_article_meta(article_id: i64, data: &str) -> bool {
    unsafe {
        host_update_article_meta(
            article_id as i32,
            data.as_ptr() as i32,
            data.len() as i32,
        ) > 0
    }
}

// ç¤ºä¾‹ï¼šAI æ‘˜è¦æ’ä»¶å†™å…¥æ‘˜è¦
let summary_data = r#"{"summary":"è¿™ç¯‡æ–‡ç« è®²äº†...","generated_at":"2026-02-12"}"#;
update_article_meta(article_id, summary_data);
// æ–‡ç«  meta å­—æ®µç»“æœ: {"ai-summary": {"summary":"è¿™ç¯‡æ–‡ç« è®²äº†...","generated_at":"2026-02-12"}}
```

> **å‘½åç©ºé—´éš”ç¦»**ï¼šæ¯ä¸ªæ’ä»¶åªèƒ½å†™å…¥è‡ªå·± `plugin_id` å¯¹åº”çš„å‘½åç©ºé—´ã€‚ä¾‹å¦‚ `ai-summary` æ’ä»¶å†™å…¥çš„æ•°æ®ä¼šå­˜å‚¨åœ¨ `meta["ai-summary"]` ä¸‹ï¼Œä¸ä¼šå½±å“å…¶ä»–æ’ä»¶çš„æ•°æ®ã€‚æ–‡ç«  API è¿”å›æ—¶ä¼šåŒ…å«å®Œæ•´çš„ `meta` å­—æ®µã€‚

### è‡ªå®šä¹‰ API è·¯ç”±

æ’ä»¶å¯ä»¥æ³¨å†Œè‡ªå®šä¹‰çš„ HTTP API ç«¯ç‚¹ã€‚åœ¨ `plugin.json` ä¸­å£°æ˜ `"api": true`ï¼Œå¹¶åœ¨ WASM ä¸­å¯¼å‡º `handle_request` å‡½æ•°ã€‚

#### plugin.json é…ç½®

```json
{
  "id": "my-plugin",
  "api": true,
  ...
}
```

#### è·¯ç”±æ ¼å¼

```
ANY /api/v1/plugins/{plugin_id}/api/{path}
```

ä¾‹å¦‚ï¼š`GET /api/v1/plugins/ai-summary/api/status` æˆ– `POST /api/v1/plugins/my-plugin/api/webhook`

#### WASM ç«¯å®ç°

å¯¼å‡º `handle_request` å‡½æ•°ï¼Œæ¥æ”¶è¯·æ±‚ JSONï¼Œè¿”å›å“åº” JSONï¼š

```rust
#[no_mangle]
pub extern "C" fn handle_request(ptr: i32, len: i32) -> i32 {
    // è¾“å…¥ JSON: {"method":"GET","path":"status","body":""}
    let method = extract_json_string(input, "method").unwrap_or_default();
    let path = extract_json_string(input, "path").unwrap_or_default();
    let body = extract_json_string(input, "body").unwrap_or_default();

    // å¤„ç†è¯·æ±‚...
    let response = match (method.as_str(), path.as_str()) {
        ("GET", "status") => r#"{"status":200,"body":"{\"ok\":true}"}"#,
        _ => r#"{"status":404,"body":"{\"error\":\"not found\"}"}"#,
    };

    write_response(response)
}
```

#### å“åº”æ ¼å¼

```json
{
  "status": 200,
  "content_type": "application/json",
  "body": "{\"ok\":true}"
}
```

- `status`ï¼šHTTP çŠ¶æ€ç ï¼Œé»˜è®¤ 200
- `content_type`ï¼šå“åº”ç±»å‹ï¼Œé»˜è®¤ `application/json`
- `body`ï¼šå“åº”ä½“å­—ç¬¦ä¸²

> **æ³¨æ„**ï¼šè‡ªå®šä¹‰ API è·¯ç”±æ˜¯å…¬å¼€çš„ï¼Œä¸éœ€è¦è®¤è¯ã€‚æ’ä»¶å†…éƒ¨å¯é€šè¿‡ `host_storage` å®ç°ç®€å•çš„é‰´æƒé€»è¾‘ã€‚æ¯ä¸ªè¯·æ±‚ä¼šå¯åŠ¨ä¸€ä¸ª wasm-worker å­è¿›ç¨‹æ‰§è¡Œï¼Œé€‚åˆä½é¢‘åœºæ™¯ã€‚

### æ•°æ®ä¼ é€’åè®®

ä¸»ç¨‹åºä¸ WASM æ¨¡å—ä¹‹é—´é€šè¿‡çº¿æ€§å†…å­˜ä¼ é€’æ•°æ®ï¼š

1. ä¸»ç¨‹åºè°ƒç”¨ `allocate(size)` åœ¨ WASM å†…å­˜ä¸­åˆ†é…ç¼“å†²åŒº
2. ä¸»ç¨‹åºå°† JSON è¾“å…¥å†™å…¥ç¼“å†²åŒº
3. ä¸»ç¨‹åºè°ƒç”¨ `hook_xxx(ptr, len)` æ‰§è¡Œé’©å­
4. é’©å­å‡½æ•°è¿”å› result_ptrï¼š
   - `0`ï¼šæ— è¾“å‡ºï¼ˆæˆåŠŸä½†æ— æ•°æ®è¿”å›ï¼‰
   - `> 0`ï¼šæŒ‡å‘ç»“æœæ•°æ®ï¼ˆå‰ 4 å­—èŠ‚ä¸ºå°ç«¯é•¿åº¦ï¼Œåè·Ÿ JSON å­—èŠ‚ï¼‰

å¿…é¡»å¯¼å‡ºçš„å‡½æ•°ï¼š

```rust
#[no_mangle]
pub extern "C" fn allocate(size: i32) -> i32 {
    if size <= 0 || size > 4 * 1024 * 1024 { return 0; }
    let layout = match Layout::from_size_align(size as usize, 1) {
        Ok(l) => l,
        Err(_) => return 0,
    };
    let ptr = unsafe { alloc(layout) };
    if ptr.is_null() { 0 } else { ptr as i32 }
}
```

è¯»å–å®¿ä¸»å‡½æ•°è¿”å›çš„ç»“æœï¼š

```rust
fn read_result(ptr: i32) -> Option<String> {
    if ptr <= 0 { return None; }
    unsafe {
        let rp = ptr as usize;
        let len_bytes = slice::from_raw_parts(rp as *const u8, 4);
        let len = u32::from_le_bytes([len_bytes[0], len_bytes[1], len_bytes[2], len_bytes[3]]) as usize;
        if len == 0 || len > 2 * 1024 * 1024 { return None; }
        let data = slice::from_raw_parts((rp + 4) as *const u8, len);
        String::from_utf8(data.to_vec()).ok()
    }
}
```

å†™å‡ºé’©å­è¿”å›å€¼ï¼š

```rust
fn write_output(json: &str) -> i32 {
    let bytes = json.as_bytes();
    let total = 4 + bytes.len();
    let layout = match Layout::from_size_align(total, 1) {
        Ok(l) => l,
        Err(_) => return 0,
    };
    let ptr = unsafe { alloc(layout) };
    if ptr.is_null() { return 0; }
    unsafe {
        let len_bytes = (bytes.len() as u32).to_le_bytes();
        std::ptr::copy_nonoverlapping(len_bytes.as_ptr(), ptr, 4);
        std::ptr::copy_nonoverlapping(bytes.as_ptr(), ptr.add(4), bytes.len());
    }
    ptr as i32
}
```

### é’©å­è¾“å…¥æ•°æ®

é’©å­å‡½æ•°æ¥æ”¶çš„ JSON è¾“å…¥åŒ…å«ä¸¤éƒ¨åˆ†ï¼š
1. **é’©å­äº‹ä»¶æ•°æ®**ï¼šç”±è§¦å‘ç‚¹æä¾›ï¼ˆå¦‚æ–‡ç«  IDã€æ ‡é¢˜ã€å†…å®¹ç­‰ï¼‰
2. **æ’ä»¶è®¾ç½®**ï¼šè‡ªåŠ¨æ³¨å…¥ï¼Œä¸åå°è®¾ç½®ç•Œé¢ä¸­çš„å€¼ä¸€è‡´

ä¾‹å¦‚ `article_after_create` é’©å­æ”¶åˆ°çš„æ•°æ®ï¼š

```json
{
  "id": 123,
  "title": "æ–‡ç« æ ‡é¢˜",
  "slug": "article-slug",
  "content": "æ–‡ç« å†…å®¹...",
  "api_url": "https://api.example.com",
  "api_key": "sk-xxx",
  "model": "gpt-4o-mini",
  "max_count": 10
}
```

å…¶ä¸­ `id`, `title`, `slug`, `content` æ¥è‡ªé’©å­äº‹ä»¶ï¼Œ`api_url`, `api_key`, `model`, `max_count` æ¥è‡ªæ’ä»¶è®¾ç½®ã€‚

### å¯ç”¨çš„åç«¯é’©å­

> é’©å­åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š**Filter**ï¼ˆè¿‡æ»¤é’©å­ï¼‰è¿”å›å€¼ä¼šæ›¿æ¢åŸå§‹æ•°æ®ï¼Œé“¾å¼ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼›**Action**ï¼ˆåŠ¨ä½œé’©å­ï¼‰è¿”å›å€¼è¢«å¿½ç•¥ï¼Œä»…ç”¨äºå‰¯ä½œç”¨æ“ä½œã€‚

#### Article é’©å­

| é’©å­å | ç±»å‹ | è§¦å‘æ—¶æœº | äº‹ä»¶æ•°æ® | è¶…æ—¶ |
|-------|------|---------|---------|------|
| `article_before_create` | Filter | æ–‡ç« åˆ›å»ºå‰ | `{ title, slug, content, author_id, category_id, status }` | 5s |
| `article_after_create` | Action | æ–‡ç« åˆ›å»ºå | `{ id, title, slug, content, author_id, category_id, status }` | 30s* |
| `article_before_update` | Filter | æ–‡ç« æ›´æ–°å‰ | `{ id, title, content, slug, category_id, status }` | 5s |
| `article_after_update` | Action | æ–‡ç« æ›´æ–°å | `{ id, title, slug, content, author_id, category_id, status }` | 30s* |
| `article_before_delete` | Filter | æ–‡ç« åˆ é™¤å‰ | `{ id, title }` | 5s |
| `article_after_delete` | Action | æ–‡ç« åˆ é™¤å | `{ id, success }` | 5s |
| `article_before_display` | Filter | æ–‡ç« æ˜¾ç¤ºå‰ | `{ article, format }` | 5s |
| `article_view` | Action | æ–‡ç« è¢«æŸ¥çœ‹æ—¶ | `{ id, slug, timestamp }` | 5s |
| `article_content_filter` | Filter | æ–‡ç« å†…å®¹è¿‡æ»¤ | `{ content, article_id }` | 5s |
| `article_excerpt_filter` | Filter | æ–‡ç« æ‘˜è¦è¿‡æ»¤ | `{ excerpt, article_id }` | 5s |

#### Comment é’©å­

| é’©å­å | ç±»å‹ | è§¦å‘æ—¶æœº | äº‹ä»¶æ•°æ® | è¶…æ—¶ |
|-------|------|---------|---------|------|
| `comment_before_create` | Filter | è¯„è®ºåˆ›å»ºå‰ | `{ article_id, content, author_name, author_email }` | 5s |
| `comment_after_create` | Action | è¯„è®ºåˆ›å»ºå | `{ id, article_id, content, author_name }` | 5s |
| `comment_before_delete` | Filter | è¯„è®ºåˆ é™¤å‰ | `{ id }` | 5s |
| `comment_after_delete` | Action | è¯„è®ºåˆ é™¤å | `{ id, success }` | 5s |
| `comment_before_display` | Filter | è¯„è®ºæ˜¾ç¤ºå‰ | `{ comments, count }` | 5s |
| `comment_content_filter` | Filter | è¯„è®ºå†…å®¹è¿‡æ»¤ | `{ content, article_id }` | 5s |

#### User é’©å­

| é’©å­å | ç±»å‹ | è§¦å‘æ—¶æœº | äº‹ä»¶æ•°æ® | è¶…æ—¶ |
|-------|------|---------|---------|------|
| `user_login_before` | Filter | ç”¨æˆ·ç™»å½•å‰ | `{ username_or_email, timestamp }` | 5s |
| `user_login_after` | Action | ç”¨æˆ·ç™»å½•å | `{ user_id, username, timestamp }` | 5s |
| `user_login_failed` | Action | ç™»å½•å¤±è´¥æ—¶ | `{ username_or_email, reason, timestamp }` | 5s |
| `user_logout` | Action | ç”¨æˆ·ç™»å‡ºæ—¶ | `{ session_id, timestamp }` | 5s |
| `user_register_before` | Filter | ç”¨æˆ·æ³¨å†Œå‰ | `{ username, email, timestamp }` | 5s |
| `user_register_after` | Action | ç”¨æˆ·æ³¨å†Œå | `{ id, username, email, timestamp }` | 5s |

#### Content Processing é’©å­

| é’©å­å | ç±»å‹ | è§¦å‘æ—¶æœº | äº‹ä»¶æ•°æ® | è¶…æ—¶ |
|-------|------|---------|---------|------|
| `markdown_before_parse` | Filter | Markdown è§£æå‰ | `{ content }` | 5s |
| `markdown_after_parse` | Action | Markdown è§£æå | `{ html }` | 5s |
| `excerpt_generate` | Filter | æ‘˜è¦ç”Ÿæˆæ—¶ | `{ content, excerpt }` | 5s |

#### System é’©å­

| é’©å­å | ç±»å‹ | è§¦å‘æ—¶æœº | äº‹ä»¶æ•°æ® | è¶…æ—¶ |
|-------|------|---------|---------|------|
| `system_init` | Action | ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ | `{ version, timestamp }` | 5s |
| `cache_clear` | Action | ç¼“å­˜æ¸…é™¤æ—¶ | `{ scope, timestamp }` | 5s |
| `theme_switch` | Action | ä¸»é¢˜åˆ‡æ¢æ—¶ | `{ old_theme, new_theme, timestamp }` | 5s |
| `api_request_before` | Filter | API è¯·æ±‚å¤„ç†å‰ | `{ method, path, timestamp }` | 5s |
| `api_request_after` | Action | API è¯·æ±‚å¤„ç†å | `{ method, path, status, timestamp }` | 5s |

#### Plugin é’©å­

| é’©å­å | ç±»å‹ | è§¦å‘æ—¶æœº | äº‹ä»¶æ•°æ® | è¶…æ—¶ |
|-------|------|---------|---------|------|
| `plugin_activate` | Action | æ’ä»¶å¯ç”¨æ—¶ | `{ plugin_id }` + è®¾ç½® | 300s |
| `plugin_deactivate` | Action | æ’ä»¶ç¦ç”¨æ—¶ | `{ plugin_id }` | 5s |
| `plugin_destroy` | Action | æ’ä»¶è¢«ç¦ç”¨æ—¶ï¼ˆWASM å¸è½½å‰ï¼‰ | `{ plugin_id }` | 5s |
| `plugin_upgrade` | Action | æ’ä»¶ç‰ˆæœ¬å˜æ›´æ—¶ | `{ plugin_id, old_version, new_version }` | 5s |
| `plugin_action` | Action | è‡ªå®šä¹‰æ“ä½œ | `{ plugin_id, action, data }` + è®¾ç½® | 30s* |

> *å¸¦ `network` æƒé™çš„æ’ä»¶è‡ªåŠ¨è·å¾— 30s è¶…æ—¶ï¼›`plugin_activate` å›ºå®š 300sï¼ˆç”¨äºæ‰¹é‡å¤„ç†ï¼‰ã€‚

#### é’©å­æ ¡éªŒ

å¯ç”¨æ’ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¡éªŒ `plugin.json` ä¸­å£°æ˜çš„é’©å­ï¼š
- æ£€æŸ¥é’©å­åç§°æ˜¯å¦å­˜åœ¨äºæ³¨å†Œè¡¨ä¸­
- æ£€æŸ¥é’©å­çš„ scope æ˜¯å¦åŒ¹é…ï¼ˆbackend é’©å­ä¸èƒ½å£°æ˜åœ¨ `hooks.frontend` ä¸­ï¼Œåä¹‹äº¦ç„¶ï¼‰
- æ ¡éªŒä¸é€šè¿‡æ—¶è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä½†ä¸é˜»æ­¢æ’ä»¶åŠ è½½ï¼ˆå‘å‰å…¼å®¹ï¼‰

### ç³»ç»Ÿé’©å­è¯¦è§£

#### plugin_activate

æ’ä»¶å¯ç”¨æ—¶è§¦å‘ï¼Œé€‚åˆæ‰¹é‡å¤„ç†å­˜é‡æ•°æ®ã€‚ä¾‹å¦‚ AI æ‘˜è¦æ’ä»¶å¯ç”¨æ—¶ä¸ºæ‰€æœ‰æ—§æ–‡ç« ç”Ÿæˆæ‘˜è¦ã€‚

```rust
#[no_mangle]
pub extern "C" fn hook_plugin_activate(ptr: i32, len: i32) -> i32 {
    // è§£æè¾“å…¥...
    let plugin_id = extract_json_string(input, "plugin_id").unwrap_or_default();
    if plugin_id != "my-plugin" { return 0; } // åªå¤„ç†è‡ªå·±

    // æŸ¥è¯¢æ‰€æœ‰æ–‡ç« 
    let articles = query_articles().unwrap_or_default();
    // æ‰¹é‡å¤„ç†...
    0
}
```

#### plugin_action

é€šç”¨çš„è‡ªå®šä¹‰æ“ä½œå…¥å£ã€‚å‰ç«¯é€šè¿‡ `POST /admin/plugins/:id/action/:action` è§¦å‘ã€‚

```rust
#[no_mangle]
pub extern "C" fn hook_plugin_action(ptr: i32, len: i32) -> i32 {
    // è§£æè¾“å…¥...
    let plugin_id = extract_json_string(input, "plugin_id").unwrap_or_default();
    if plugin_id != "my-plugin" { return 0; }

    let action = extract_json_string(input, "action").unwrap_or_default();
    match action.as_str() {
        "regenerate" => handle_regenerate(input),
        "cleanup" => handle_cleanup(input),
        _ => 0,
    }
}
```

#### article_after_delete

æ–‡ç« åˆ é™¤åè§¦å‘ï¼Œé€‚åˆæ¸…ç†å…³è”æ•°æ®ï¼š

```rust
#[no_mangle]
pub extern "C" fn hook_article_after_delete(ptr: i32, len: i32) -> i32 {
    // è§£æè¾“å…¥è·å– article id...
    let article_id = extract_json_number(input, "id").unwrap_or(0);
    // æ¸…ç†å­˜å‚¨çš„æ•°æ®
    storage_delete(&format!("data:{}", article_id));
    0
}
```

#### plugin_destroy

æ’ä»¶è¢«ç¦ç”¨æ—¶è§¦å‘ï¼ˆåœ¨ WASM æ¨¡å—å¸è½½ä¹‹å‰ï¼‰ï¼Œé€‚åˆæ¸…ç†èµ„æºã€‚å³ä½¿é’©å­æ‰§è¡Œå¤±è´¥ï¼Œæ’ä»¶ç¦ç”¨æµç¨‹ä¹Ÿä¼šç»§ç»­å®Œæˆã€‚

```rust
#[no_mangle]
pub extern "C" fn hook_plugin_destroy(ptr: i32, len: i32) -> i32 {
    // è§£æè¾“å…¥...
    let plugin_id = extract_json_string(input, "plugin_id").unwrap_or_default();
    if plugin_id != "my-plugin" { return 0; }

    // æ¸…ç†ä¸´æ—¶æ•°æ®ã€å…³é—­è¿æ¥ç­‰
    storage_delete("temp_cache");
    log("info", "Plugin resources cleaned up");
    0
}
```

#### plugin_upgrade

æ’ä»¶ç‰ˆæœ¬å˜æ›´æ—¶è§¦å‘ï¼ˆå¯ç”¨æ’ä»¶æ—¶æ£€æµ‹åˆ° plugin.json ç‰ˆæœ¬ä¸ä¸Šæ¬¡è®°å½•ä¸åŒï¼‰ï¼Œé€‚åˆæ•°æ®è¿ç§»ã€‚å³ä½¿é’©å­æ‰§è¡Œå¤±è´¥ï¼Œæ’ä»¶å¯ç”¨æµç¨‹ä¹Ÿä¼šç»§ç»­å®Œæˆã€‚

```rust
#[no_mangle]
pub extern "C" fn hook_plugin_upgrade(ptr: i32, len: i32) -> i32 {
    // è§£æè¾“å…¥...
    let plugin_id = extract_json_string(input, "plugin_id").unwrap_or_default();
    if plugin_id != "my-plugin" { return 0; }

    let old_version = extract_json_string(input, "old_version").unwrap_or_default();
    let new_version = extract_json_string(input, "new_version").unwrap_or_default();
    log("info", &format!("Upgrading from {} to {}", old_version, new_version));

    // æ‰§è¡Œæ•°æ®è¿ç§»é€»è¾‘...
    0
}
```

### æ²™ç›’å®‰å…¨æœºåˆ¶

| é™åˆ¶é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|-------|------|
| å†…å­˜é™åˆ¶ | 16 MB | é˜²æ­¢å†…å­˜æ³„æ¼ |
| æŒ‡ä»¤é™åˆ¶ | 1 äº¿æ¡ï¼ˆfuelï¼‰ | é˜²æ­¢æ­»å¾ªç¯ |
| æ‰§è¡Œè¶…æ—¶ | 5s / 30s / 300s | æ ¹æ®é’©å­ç±»å‹è‡ªåŠ¨è°ƒæ•´ |
| æƒé™æ§åˆ¶ | ç™½åå• | åªèƒ½ä½¿ç”¨ plugin.json ä¸­å£°æ˜çš„æƒé™ |
| è¿›ç¨‹éš”ç¦» | å­è¿›ç¨‹ | æ¯æ¬¡è°ƒç”¨ç‹¬ç«‹å­è¿›ç¨‹ï¼Œå´©æºƒä¸å½±å“ä¸»ç¨‹åº |
| HTTP è¶…æ—¶ | 10s | å•æ¬¡ HTTP è¯·æ±‚è¶…æ—¶ |
| HTTP å“åº”é™åˆ¶ | 1 MB | å“åº”ä½“å¤§å°é™åˆ¶ |

### JSON è§£æå·¥å…·

ç”±äº WASM æ’ä»¶ä¸å¼•å…¥å¤–éƒ¨ä¾èµ–ï¼Œéœ€è¦æ‰‹åŠ¨è§£æ JSONã€‚ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„å·¥å…·å‡½æ•°ï¼š

```rust
/// ä» JSON ä¸­æå–å­—ç¬¦ä¸²å€¼ï¼ˆæ”¯æŒ UTF-8 å’Œ \uXXXX è½¬ä¹‰ï¼‰
fn extract_json_string(json: &str, key: &str) -> Option<String> {
    let pattern = format!("\"{}\":", key);
    let start = json.find(&pattern)? + pattern.len();
    let rest = json[start..].trim_start();
    if !rest.starts_with('"') { return None; }
    let rest = &rest[1..];

    let mut result = Vec::new();
    let bytes = rest.as_bytes();
    let mut i = 0;
    while i < bytes.len() {
        if bytes[i] == b'"' { break; }
        if bytes[i] == b'\\' && i + 1 < bytes.len() {
            i += 1;
            match bytes[i] {
                b'n' => result.push(b'\n'),
                b't' => result.push(b'\t'),
                b'r' => result.push(b'\r'),
                b'"' => result.push(b'"'),
                b'\\' => result.push(b'\\'),
                b'/' => result.push(b'/'),
                b'u' if i + 4 < bytes.len() => {
                    // \uXXXX unicode è½¬ä¹‰å¤„ç†
                    // ... å®Œæ•´å®ç°è§ ai-summary æ’ä»¶æºç 
                    i += 4;
                    continue;
                }
                other => { result.push(b'\\'); result.push(other); }
            }
        } else {
            result.push(bytes[i]);
        }
        i += 1;
    }
    String::from_utf8(result).ok()
}

/// ä» JSON ä¸­æå–æ•°å­—å€¼
fn extract_json_number(json: &str, key: &str) -> Option<i64> {
    let pattern = format!("\"{}\":", key);
    let start = json.find(&pattern)? + pattern.len();
    let rest = json[start..].trim_start();
    let end = rest.find(|c: char| !c.is_ascii_digit() && c != '-')?;
    rest[..end].parse().ok()
}

/// JSON å­—ç¬¦ä¸²è½¬ä¹‰
fn escape_json_string(s: &str) -> String {
    let mut out = String::with_capacity(s.len());
    for c in s.chars() {
        match c {
            '"' => out.push_str("\\\""),
            '\\' => out.push_str("\\\\"),
            '\n' => out.push_str("\\n"),
            '\r' => out.push_str("\\r"),
            '\t' => out.push_str("\\t"),
            c if (c as u32) < 0x20 => {
                out.push_str(&format!("\\u{:04x}", c as u32));
            }
            c => out.push(c),
        }
    }
    out
}
```

> å®Œæ•´çš„ JSON å·¥å…·å‡½æ•°å®ç°å¯å‚è€ƒ `plugins/ai-summary/wasm-src/src/lib.rs`ã€‚

### UTF-8 æ³¨æ„äº‹é¡¹

å¤„ç†ä¸­æ–‡ç­‰å¤šå­—èŠ‚å­—ç¬¦æ—¶éœ€è¦æ³¨æ„ï¼š
- å­—ç¬¦ä¸²æˆªæ–­å¿…é¡»åœ¨å­—ç¬¦è¾¹ç•Œï¼šä½¿ç”¨ `is_char_boundary()` æ£€æŸ¥
- ä¸è¦ç”¨ `b as char` è½¬æ¢å­—èŠ‚ä¸ºå­—ç¬¦ï¼Œåº”æ”¶é›†å­—èŠ‚åç”¨ `String::from_utf8()`
- JSON ä¸­çš„ `\uXXXX` è½¬ä¹‰éœ€è¦å¤„ç† surrogate pairï¼ˆ`\uD800-\uDFFF`ï¼‰

```rust
// å®‰å…¨æˆªæ–­ UTF-8 å­—ç¬¦ä¸²
let truncated = if content.len() > max_len {
    let mut end = max_len;
    while end > 0 && !content.is_char_boundary(end) {
        end -= 1;
    }
    &content[..end]
} else {
    content
};
```

---

## å›½é™…åŒ–ï¼ˆi18nï¼‰

æ’ä»¶æ”¯æŒé€šè¿‡ `locales/` ç›®å½•æä¾›å¤šè¯­è¨€ç¿»è¯‘ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨åŠ è½½å¹¶æ³¨å…¥åˆ° SDK çš„ i18n ç³»ç»Ÿä¸­ã€‚

### ç›®å½•ç»“æ„

```
plugins/my-plugin/
  locales/
    zh-CN.json    # ç®€ä½“ä¸­æ–‡
    en.json       # è‹±æ–‡
    ja.json       # æ—¥æ–‡ï¼ˆæŒ‰éœ€æ·»åŠ ï¼‰
```

### ç¿»è¯‘æ–‡ä»¶æ ¼å¼

çº¯ JSONï¼Œé”®å€¼å¯¹ç»“æ„ï¼š

```json
{
  "greeting": "ä½ å¥½",
  "submitBtn": "æäº¤",
  "error": "æ“ä½œå¤±è´¥"
}
```

### ä½¿ç”¨æ–¹å¼

æ¡†æ¶ä¼šè‡ªåŠ¨å°†ç¿»è¯‘æ³¨å†Œåˆ° `Noteva.i18n`ï¼Œå‘½åç©ºé—´ä¸ºæ’ä»¶ IDã€‚åœ¨ `frontend.js` ä¸­ç›´æ¥è°ƒç”¨ï¼š

```javascript
// æ’ä»¶ ID ä¸º "my-plugin"
Noteva.i18n.t('my-plugin.greeting')   // â†’ "ä½ å¥½"ï¼ˆå½“å‰è¯­è¨€ä¸º zh-CN æ—¶ï¼‰
Noteva.i18n.t('my-plugin.submitBtn')  // â†’ "Submit"ï¼ˆå½“å‰è¯­è¨€ä¸º en æ—¶ï¼‰
```

æ— éœ€æ‰‹åŠ¨è°ƒç”¨ `addMessages`ï¼Œæ— éœ€ç¼–è¯‘ï¼Œæ”¾å¥½ JSON æ–‡ä»¶å³å¯ã€‚

---

## API å‚è€ƒ

### å…¬å¼€ APIï¼ˆæ— éœ€ç™»å½•ï¼‰

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| GET | `/api/v1/plugins/assets/plugins.js` | æ‰€æœ‰å¯ç”¨æ’ä»¶çš„åˆå¹¶ JS |
| GET | `/api/v1/plugins/assets/plugins.css` | æ‰€æœ‰å¯ç”¨æ’ä»¶çš„åˆå¹¶ CSS |
| GET | `/api/v1/plugins/enabled` | å¯ç”¨çš„æ’ä»¶åˆ—è¡¨åŠè®¾ç½®ï¼ˆsecret å­—æ®µå·²è¿‡æ»¤ï¼‰ |
| GET | `/api/v1/plugins/:id/data/:key` | è¯»å–æ’ä»¶å­˜å‚¨æ•°æ® |

### ç®¡ç† APIï¼ˆéœ€è¦ç®¡ç†å‘˜ç™»å½•ï¼‰

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| GET | `/api/v1/admin/plugins` | æ’ä»¶åˆ—è¡¨ |
| GET | `/api/v1/admin/plugins/:id` | æ’ä»¶è¯¦æƒ… |
| POST | `/api/v1/admin/plugins/:id/toggle` | å¯ç”¨/ç¦ç”¨æ’ä»¶ |
| GET | `/api/v1/admin/plugins/:id/settings` | è·å–æ’ä»¶è®¾ç½® |
| POST | `/api/v1/admin/plugins/:id/settings` | æ›´æ–°æ’ä»¶è®¾ç½® |
| GET | `/api/v1/admin/plugins/:id/data/:key` | è¯»å–æ’ä»¶æ•°æ® |
| PUT | `/api/v1/admin/plugins/:id/data/:key` | å†™å…¥æ’ä»¶æ•°æ® |
| DELETE | `/api/v1/admin/plugins/:id/data/:key` | åˆ é™¤æ’ä»¶æ•°æ® |
| POST | `/api/v1/admin/plugins/:id/action/:action` | è§¦å‘æ’ä»¶è‡ªå®šä¹‰æ“ä½œ |
| GET | `/api/v1/admin/plugins/wasm/status` | WASM è¿è¡Œæ—¶çŠ¶æ€ |

---

## è°ƒè¯•æŠ€å·§

1. æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ `[Plugin] xxx loaded` ç¡®è®¤å‰ç«¯åŠ è½½
2. æœåŠ¡ç«¯æ—¥å¿—æŸ¥çœ‹ `[wasm:plugin-id]` å‰ç¼€çš„ WASM æ’ä»¶æ—¥å¿—
3. ä½¿ç”¨ `host_log("info", "debug message")` åœ¨ WASM ä¸­è¾“å‡ºè°ƒè¯•ä¿¡æ¯
4. æ£€æŸ¥ `/api/v1/plugins/enabled` ç¡®è®¤æ’ä»¶è®¾ç½®æ˜¯å¦æ­£ç¡®åŠ è½½
5. æ£€æŸ¥ `/api/v1/plugins/:id/data/:key` ç¡®è®¤å­˜å‚¨æ•°æ®æ˜¯å¦æ­£ç¡®å†™å…¥
6. ç¼–è¯‘åç¡®ä¿ `backend.wasm` å·²å¤åˆ¶åˆ°æ’ä»¶ç›®å½•
7. debug å’Œ release æ¨¡å¼çš„ `wasm-worker` æ˜¯ç‹¬ç«‹çš„ï¼Œä¿®æ”¹åä¸¤ä¸ªéƒ½éœ€è¦é‡æ–°ç¼–è¯‘

### å¸¸è§é—®é¢˜

**Q: WASM æ’ä»¶åŠ è½½å¤±è´¥ï¼ŒæŠ¥ `unknown import: wasi_snapshot_preview1::fd_write`**
A: ä½¿ç”¨ `wasm32-wasip1` ç¼–è¯‘çš„æ¨¡å—éœ€è¦ WASI æ”¯æŒã€‚ç¡®ä¿ Noteva ç‰ˆæœ¬ >= 0.1.3-betaï¼Œè¯¥ç‰ˆæœ¬å·²å†…ç½® WASI stubsã€‚

**Q: æ’ä»¶è®¾ç½®åœ¨å‰ç«¯è·å–ä¸ºç©ºå¯¹è±¡**
A: ç”¨æˆ·æœªåœ¨åå°ä¿å­˜è¿‡è®¾ç½®æ—¶ï¼Œ`getSettings()` è¿”å› `{}`ã€‚æ£€æŸ¥å¼€å…³ç±»è®¾ç½®åº”ä½¿ç”¨ `=== false` è€Œé `!value`ã€‚

**Q: å­˜å‚¨æ•°æ® API è¿”å› HTML è€Œé JSON**
A: ç¡®è®¤è¯·æ±‚è·¯å¾„æ­£ç¡®ï¼ˆ`/api/v1/plugins/:id/data/:key`ï¼‰ï¼Œæ£€æŸ¥ Content-Type å“åº”å¤´ã€‚

**Q: cargo build å wasm-worker æ²¡æ›´æ–°**
A: cargo å¢é‡ç¼–è¯‘å¯èƒ½è·³è¿‡é“¾æ¥ã€‚åˆ é™¤æ—§çš„ exe æ–‡ä»¶åé‡æ–°ç¼–è¯‘ï¼Œæˆ– touch æºæ–‡ä»¶å¼ºåˆ¶é‡ç¼–è¯‘ã€‚
